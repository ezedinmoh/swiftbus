<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Ticket - SwiftBus</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a73e8;
            --secondary: #ff6d00;
            --dark: #222;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background-color: white;
            box-shadow: var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo h1 {
            color: var(--primary);
            font-size: 28px;
            font-weight: 700;
        }

        .logo span {
            color: var(--secondary);
        }

        .back-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: #0d47a1;
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-content {
            padding-top: 100px;
            padding-bottom: 80px;
        }

        .booking-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .booking-header h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .booking-header p {
            color: var(--gray);
            font-size: 1.1rem;
        }

        /* Bus Selection Banner */
        .bus-selection-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .bus-selection-banner .bus-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .bus-selection-banner i {
            font-size: 3rem;
            opacity: 0.9;
        }

        .bus-selection-banner h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .bus-selection-banner p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .change-bus-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .change-bus-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Progress Steps */
        .booking-progress {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            position: relative;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            width: 120px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #e9ecef;
            color: var(--gray);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .progress-step.active .step-number {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .progress-step.completed .step-number {
            background: var(--success);
            color: white;
        }

        .step-label {
            font-size: 14px;
            color: var(--gray);
            text-align: center;
        }

        .progress-step.active .step-label {
            color: var(--primary);
            font-weight: 500;
        }

        .progress-line {
            position: absolute;
            top: 20px;
            left: 60px;
            right: 60px;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }

        .progress-fill {
            position: absolute;
            top: 20px;
            left: 60px;
            height: 2px;
            background: var(--primary);
            z-index: 1;
            transition: width 0.3s ease;
        }

        /* Booking Form */
        .booking-form {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 40px;
            display: none;
        }

        .form-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section h2 {
            color: var(--primary);
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section h2 i {
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .required::after {
            content: " *";
            color: var(--danger);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .form-control.select {
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E") no-repeat right 15px center;
            appearance: none;
            padding-right: 40px;
        }

        /* Seat Selection */
        .seat-map-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .seat-map {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .seat {
            width: 60px;
            height: 60px;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: bold;
            position: relative;
        }

        .seat.available {
            background: white;
            border-color: var(--success);
        }

        .seat.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .seat.occupied {
            background: var(--gray);
            color: white;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .seat.women-only {
            border-color: #e91e63;
        }

        .seat.women-only::after {
            content: '♀';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
            color: #e91e63;
        }

        .seat.accessible {
            border-color: #ff9800;
        }

        .seat.accessible::after {
            content: '♿';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
            color: #ff9800;
        }

        .seat-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid;
        }

        .legend-color.available { background: white; border-color: var(--success); }
        .legend-color.selected { background: var(--primary); border-color: var(--primary); }
        .legend-color.occupied { background: var(--gray); border-color: var(--gray); }
        .legend-color.women-only { background: white; border-color: #e91e63; }
        .legend-color.accessible { background: white; border-color: #ff9800; }

        /* Payment Options */
        .payment-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .payment-option {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .payment-option:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .payment-option.selected {
            border-color: var(--primary);
            background: rgba(26, 115, 232, 0.1);
        }

        .payment-option i {
            font-size: 40px;
            color: var(--primary);
        }

        .payment-option .pay-now-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            width: 100%;
        }

        .payment-option .pay-now-btn:hover {
            background: #0d47a1;
            transform: translateY(-2px);
        }

        .payment-instruction {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            border-left: 4px solid var(--primary);
        }

        .payment-instruction i {
            color: var(--primary);
            margin-right: 10px;
        }

        /* Booking Summary */
        .booking-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .summary-item.total {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
            border-bottom: none;
            padding-top: 15px;
            margin-top: 15px;
            border-top: 2px solid #ddd;
        }

        /* Form Navigation */
        .form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }

        .btn {
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0d47a1;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Error Messages */
        .error-message {
            color: var(--danger);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .form-control.error {
            border-color: var(--danger);
        }

        /* Confirmation Modal */
        .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .confirmation-modal.active {
            display: flex;
        }

        .confirmation-content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: modalAppear 0.3s ease;
        }

        @keyframes modalAppear {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .confirmation-icon {
            width: 80px;
            height: 80px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 32px;
        }

        .confirmation-content h2 {
            color: var(--success);
            margin-bottom: 15px;
        }

        .confirmation-content p {
            color: var(--gray);
            margin-bottom: 25px;
        }

        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 60px 0 20px;
            margin-top: 60px;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        .footer-column h3 {
            font-size: 20px;
            margin-bottom: 20px;
            position: relative;
            padding-bottom: 10px;
        }

        .footer-column h3::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 40px;
            height: 3px;
            background: var(--secondary);
            border-radius: 2px;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 12px;
        }

        .footer-links a {
            color: #bbb;
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-links a:hover {
            color: white;
            padding-left: 5px;
        }

        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #bbb;
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .booking-progress {
                flex-wrap: wrap;
                gap: 20px;
            }

            .progress-step {
                width: 100px;
            }

            .progress-line, .progress-fill {
                display: none;
            }

            .bus-selection-banner {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .bus-selection-banner .bus-info {
                flex-direction: column;
                gap: 10px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .seat-map {
                grid-template-columns: repeat(3, 1fr);
            }

            .seat {
                width: 50px;
                height: 50px;
            }

            .payment-options {
                grid-template-columns: 1fr;
            }

            .form-navigation {
                flex-direction: column;
                gap: 15px;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .booking-form {
                padding: 25px;
            }

            .seat-map {
                grid-template-columns: repeat(2, 1fr);
            }

            .seat {
                width: 45px;
                height: 45px;
                font-size: 14px;
            }

            .confirmation-content {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-top">
                <div class="logo">
                    <h1>Swift<span>Bus</span></h1>
                </div>
                <a href="#" class="back-btn" id="backBtn">
                    <i class="fas fa-arrow-left"></i>
                    <span id="backBtnText">Back</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Booking Header -->
            <div class="booking-header">
                <h1>Book Your Bus Ticket</h1>
                <p>Complete the form below to book your journey</p>
            </div>

            <!-- Bus Selection Banner -->
            <div class="bus-selection-banner">
                <div class="bus-info">
                    <i class="fas fa-bus"></i>
                    <div>
                        <h3 id="selectedCompanyName">Selam Bus</h3>
                        <p id="selectedBusType">Premium AC Bus</p>
                    </div>
                </div>
                <button class="change-bus-btn" onclick="document.getElementById('busCompany').focus()">
                    <i class="fas fa-exchange-alt"></i> Change Bus
                </button>
            </div>

            <!-- Progress Steps -->
            <div class="booking-progress">
                <div class="progress-line"></div>
                <div class="progress-fill" id="progressFill"></div>
                
                <div class="progress-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Trip Details</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Passenger Info</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Seat Selection</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Payment</div>
                </div>
            </div>

            <!-- Booking Form -->
            <form id="bookingForm" class="booking-form">
                <!-- Step 1: Trip Details -->
                <div class="form-section active" data-step="1">
                    <h2><i class="fas fa-route"></i> Trip Details</h2>
                    
                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label class="form-label required">Bus Company</label>
                                <select class="form-control select" id="busCompany" name="busCompany" required>
                                    <option value="selam-bus" selected>Selam Bus</option>
                                    <option value="abay-bus">Abay Bus</option>
                                    <option value="ethio-bus">Ethio Bus</option>
                                    <option value="habesha-bus">Habesha Bus</option>
                                </select>
                                <div class="error-message" id="busCompanyError">Please select a bus company</div>
                            </div>
                            <div>
                                <label class="form-label required">Bus Type</label>
                                <select class="form-control select" id="busType" name="busType" required>
                                    <option value="premium-ac" selected>Premium AC Bus</option>
                                    <option value="standard-ac">Standard AC Bus</option>
                                    <option value="luxury">Luxury Bus</option>
                                    <option value="standard">Standard Bus</option>
                                    <option value="economy">Economy Bus</option>
                                </select>
                                <div class="error-message" id="busTypeError">Please select a bus type</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label class="form-label required">From</label>
                                <select class="form-control select" id="fromCity" name="fromCity" required>
                                    <option value="">Select City</option>
                                    <option value="addis-ababa">Addis Ababa</option>
                                    <option value="kombolcha">Kombolcha</option>
                                    <option value="bahirdar">Bahirdar</option>
                                    <option value="dessie">Dessie</option>
                                    <option value="adama">Adama</option>
                                    <option value="hawasa">Hawasa</option>
                                    <option value="arbaminch">Arbaminch</option>
                                    <option value="gonder">Gonder</option>
                                    <option value="mekele">Mekele</option>
                                    <option value="jimma">Jimma</option>
                                </select>
                                <div class="error-message" id="fromCityError">Please select departure city</div>
                            </div>
                            <div>
                                <label class="form-label required">To</label>
                                <select class="form-control select" id="toCity" name="toCity" required>
                                    <option value="">Select City</option>
                                    <option value="addis-ababa">Addis Ababa</option>
                                    <option value="kombolcha">Kombolcha</option>
                                    <option value="bahirdar">Bahirdar</option>
                                    <option value="dessie">Dessie</option>
                                    <option value="adama">Adama</option>
                                    <option value="hawasa">Hawasa</option>
                                    <option value="arbaminch">Arbaminch</option>
                                    <option value="gonder">Gonder</option>
                                    <option value="mekele">Mekele</option>
                                    <option value="jimma">Jimma</option>
                                </select>
                                <div class="error-message" id="toCityError">Please select destination city</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label class="form-label required">Departure Date</label>
                                <input type="date" class="form-control" id="departureDate" name="departureDate" required>
                                <div class="error-message" id="departureDateError">Please select departure date</div>
                            </div>
                            <div>
                                <label class="form-label required">Departure Time</label>
                                <select class="form-control select" id="departureTime" name="departureTime" required>
                                    <option value="">Select Time</option>
                                    <option value="06:00">06:00 AM</option>
                                    <option value="08:00" selected>08:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="14:00">02:00 PM</option>
                                    <option value="18:00">06:00 PM</option>
                                    <option value="20:00">08:00 PM</option>
                                    <option value="22:00">10:00 PM</option>
                                </select>
                                <div class="error-message" id="departureTimeError">Please select departure time</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label class="form-label required">Number of Passengers</label>
                                <select class="form-control select" id="passengerCount" name="passengerCount" required>
                                    <option value="">Select Number</option>
                                    <option value="1" selected>1 Passenger</option>
                                    <option value="2">2 Passengers</option>
                                    <option value="3">3 Passengers</option>
                                    <option value="4">4 Passengers</option>
                                    <option value="5">5 Passengers</option>
                                    <option value="6">6 Passengers</option>
                                </select>
                                <div class="error-message" id="passengerCountError">Please select number of passengers</div>
                            </div>
                            <div>
                                <label class="form-label">Journey Type</label>
                                <select class="form-control select" id="journeyType" name="journeyType">
                                    <option value="one-way" selected>One Way</option>
                                    <option value="round-trip">Round Trip</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Passenger Information -->
                <div class="form-section" data-step="2">
                    <h2><i class="fas fa-user"></i> Passenger Information</h2>
                    
                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label class="form-label required">Full Name</label>
                                <input type="text" class="form-control" id="fullName" name="fullName" placeholder="Enter your full name">
                                <div class="error-message" id="fullNameError">Please enter your full name</div>
                            </div>
                            <div>
                                <label class="form-label required">Email Address</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="example@email.com">
                                <div class="error-message" id="emailError">Please enter a valid email address</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label class="form-label required">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" name="phone" placeholder="+251 911 234 567">
                                <div class="error-message" id="phoneError">Please enter a valid phone number</div>
                            </div>
                            <div>
                                <label class="form-label">Nationality</label>
                                <select class="form-control select" id="nationality" name="nationality">
                                    <option value="ethiopian" selected>Ethiopian</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label class="form-label required">ID/Passport Number</label>
                                <input type="text" class="form-control" id="idNumber" name="idNumber" placeholder="ID/Passport number" required>
                                <div class="error-message" id="idNumberError">Please enter your ID or Passport number</div>
                            </div>
                            <div>
                                <label class="form-label">Age Group</label>
                                <select class="form-control select" id="ageGroup" name="ageGroup">
                                    <option value="adult" selected>Adult (12+ years)</option>
                                    <option value="child">Child (5-11 years)</option>
                                    <option value="infant">Infant (0-4 years)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Special Requirements</label>
                        <textarea class="form-control" id="specialRequirements" name="specialRequirements" rows="3" placeholder="Any special requirements or requests..."></textarea>
                    </div>
                </div>

                <!-- Step 3: Seat Selection -->
                <div class="form-section" data-step="3">
                    <h2><i class="fas fa-chair"></i> Select Your Seat</h2>
                    
                    <div class="seat-map-container">
                        <div class="seat-map" id="seatMap">
                            <!-- Seats will be generated by JavaScript -->
                        </div>

                        <div class="seat-legend">
                            <div class="legend-item">
                                <div class="legend-color available"></div>
                                <span>Available</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color selected"></div>
                                <span>Selected</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color occupied"></div>
                                <span>Occupied</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color women-only"></div>
                                <span>Women Only</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color accessible"></div>
                                <span>Accessible</span>
                            </div>
                        </div>
                    </div>

                    <div class="booking-summary">
                        <h3 style="color: var(--primary); margin-bottom: 20px;">Selected Seats</h3>
                        <div id="selectedSeatsList" style="min-height: 40px; padding: 10px; background: white; border-radius: 8px; margin-bottom: 15px;">
                            <p style="color: var(--gray); text-align: center;">No seats selected yet</p>
                        </div>
                        <div class="summary-item">
                            <span>Seat Price:</span>
                            <span id="seatPrice">ETB 0</span>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Payment -->
                <div class="form-section" data-step="4">
                    <h2><i class="fas fa-credit-card"></i> Payment Details</h2>
                    
                    <div class="payment-instruction">
                        <i class="fas fa-info-circle"></i>
                        <strong>Important:</strong> Please review your booking details and agree to our terms before selecting your payment method.
                    </div>

                    <!-- Terms Agreement -->
                    <div class="form-group" style="margin-bottom: 30px;">
                        <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                            <input type="checkbox" id="termsAgreement" name="termsAgreement" style="width: auto; margin-top: 3px;">
                            <span style="flex: 1;">I agree to the <a href="terms-conditions.html" style="color: var(--primary); text-decoration: underline;" target="_blank">Terms & Conditions</a> and <a href="privacy-policy.html" style="color: var(--primary); text-decoration: underline;" target="_blank">Privacy Policy</a>. I understand that my booking will be confirmed only after successful payment.</span>
                        </label>
                        <div class="error-message" id="termsError">Please agree to the terms and conditions to proceed</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">Select Payment Method</label>
                        <div class="payment-options">
                            <div class="payment-option" data-method="telebirr">
                                <i class="fas fa-mobile-alt"></i>
                                <h3>Telebirr</h3>
                                <p>Pay with mobile money</p>
                                <button type="button" class="pay-now-btn" onclick="redirectToPayment('telebirr')">
                                    Pay with Telebirr
                                </button>
                            </div>
                            <div class="payment-option" data-method="cbe">
                                <i class="fas fa-university"></i>
                                <h3>CBE</h3>
                                <p>Commercial Bank of Ethiopia</p>
                                <button type="button" class="pay-now-btn" onclick="redirectToPayment('cbe')">
                                    Pay with CBE
                                </button>
                            </div>
                            <div class="payment-option" data-method="dashen">
                                <i class="fas fa-credit-card"></i>
                                <h3>Dashen Bank</h3>
                                <p>Dashen Bank Payment</p>
                                <button type="button" class="pay-now-btn" onclick="redirectToPayment('dashen')">
                                    Pay with Dashen
                                </button>
                            </div>
                            <div class="payment-option" data-method="card">
                                <i class="fas fa-credit-card"></i>
                                <h3>Card</h3>
                                <p>Credit/Debit Card</p>
                                <button type="button" class="pay-now-btn" onclick="redirectToPayment('card')">
                                    Pay with Card
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="paymentMethod" name="paymentMethod">
                        <div class="error-message" id="paymentMethodError">Please select a payment method by clicking on one of the options above</div>
                    </div>

                </div>

                <!-- Form Navigation -->
                <div class="form-navigation">
                    <button type="button" class="btn btn-secondary" id="prevBtn" disabled>
                        <i class="fas fa-arrow-left"></i>
                        Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn">
                        Next
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <!-- REMOVED: The problematic Submit Button -->
                </div>
            </form>
        </div>
    </main>

    <!-- Confirmation Modal - This will only show after payment -->
    <div class="confirmation-modal" id="confirmationModal">
        <div class="confirmation-content">
            <div class="confirmation-icon">
                <i class="fas fa-check"></i>
            </div>
            <h2>Booking Confirmed!</h2>
            <p>Your bus ticket has been successfully booked. A confirmation email has been sent to your email address.</p>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <p style="margin: 5px 0;"><strong>Booking ID:</strong> <span id="bookingId">SWB-2023-001234</span></p>
                <p style="margin: 5px 0;"><strong>Amount Paid:</strong> <span id="bookingAmount">ETB 520</span></p>
                <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: var(--success);">Confirmed</span></p>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <a href="index.html" class="btn btn-primary">
                    <i class="fas fa-home"></i>
                    Back to Home
                </a>
                <button class="btn btn-secondary" id="downloadTicket">
                    <i class="fas fa-download"></i>
                    Download Ticket
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>SwiftBus</h3>
                    <p>Your trusted partner for bus travel across Ethiopia. We connect you to your destination safely and comfortably.</p>
                    <div class="social-links">
                        <a href="https://facebook.com" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://twitter.com" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://instagram.com" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="https://www.linkedin.com/" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="routes.html">Routes</a></li>
                       
                        <li><a href="my-tickets.html">My Tickets</a></li>
                       
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Support</h3>
                    <ul class="footer-links">
                        <li><a href="contact-us.html">Contact Us</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="terms-conditions.html">Terms & Conditions</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Contact Info</h3>
                    <ul class="footer-links">
                        <li><i class="fas fa-map-marker-alt"></i> Kombolcha, Ethiopia</li>
                        <li><i class="fas fa-phone"></i> +251 945710924</li>
                        <li><i class="fas fa-envelope"></i> info@swiftbus.et</li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2025 SwiftBus. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Custom notification system
        function showNotification(message, type = 'info') {
            // Remove any existing notifications
            const existingNotifications = document.querySelectorAll('.custom-notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `custom-notification custom-notification-${type}`;
            notification.innerHTML = `
                <div class="custom-notification-content">
                    <i class="fas fa-${getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                    <button class="custom-notification-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            // Add styles if not already added
            if (!document.getElementById('custom-notification-styles')) {
                const styles = document.createElement('style');
                styles.id = 'custom-notification-styles';
                styles.textContent = `
                    .custom-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        min-width: 300px;
                        max-width: 500px;
                        padding: 15px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        animation: slideInRight 0.3s ease;
                        font-family: 'Poppins', sans-serif;
                    }
                    .custom-notification-success { 
                        background: #d4edda; 
                        color: #155724; 
                        border-left: 4px solid #28a745; 
                    }
                    .custom-notification-error { 
                        background: #f8d7da; 
                        color: #721c24; 
                        border-left: 4px solid #dc3545; 
                    }
                    .custom-notification-warning { 
                        background: #fff3cd; 
                        color: #856404; 
                        border-left: 4px solid #ffc107; 
                    }
                    .custom-notification-info { 
                        background: #d1ecf1; 
                        color: #0c5460; 
                        border-left: 4px solid #17a2b8; 
                    }
                    .custom-notification-content { 
                        display: flex; 
                        align-items: center; 
                        gap: 10px; 
                    }
                    .custom-notification-close { 
                        background: none; 
                        border: none; 
                        cursor: pointer; 
                        margin-left: auto; 
                        opacity: 0.7;
                        transition: opacity 0.2s;
                    }
                    .custom-notification-close:hover {
                        opacity: 1;
                    }
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(styles);
            }

            // Add to page
            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        function getNotificationIcon(type) {
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // Seat reservation management using localStorage
        const SEAT_RESERVATION_KEY = 'swiftbus_seat_reservations';
        const RESERVATION_TIMEOUT = 15 * 60 * 1000; // 15 minutes

        function saveSelectedSeatsToStorage() {
            const busCompany = document.getElementById('busCompany').value;
            const busType = document.getElementById('busType').value;
            const fromCity = document.getElementById('fromCity').value;
            const toCity = document.getElementById('toCity').value;
            const departureDate = document.getElementById('departureDate').value;
            const departureTime = document.getElementById('departureTime').value;
            const route = `${fromCity}-${toCity}`;
            
            if (!busCompany || !route || !departureDate || !departureTime) return;
            
            const reservationKey = `${busCompany}-${busType}-${route}-${departureDate}-${departureTime}`;
            const reservationData = {
                seats: selectedSeats,
                timestamp: Date.now(),
                expires: Date.now() + RESERVATION_TIMEOUT,
                sessionId: getSessionId()
            };
            
            // Get existing reservations
            const allReservations = JSON.parse(localStorage.getItem(SEAT_RESERVATION_KEY) || '{}');
            allReservations[reservationKey] = reservationData;
            
            // Clean up expired reservations
            cleanupExpiredReservations(allReservations);
            
            localStorage.setItem(SEAT_RESERVATION_KEY, JSON.stringify(allReservations));
            console.log('💾 Saved seat reservation:', reservationKey, selectedSeats);
        }

        function loadSelectedSeatsFromStorage() {
            const busCompany = document.getElementById('busCompany').value;
            const busType = document.getElementById('busType').value;
            const fromCity = document.getElementById('fromCity').value;
            const toCity = document.getElementById('toCity').value;
            const departureDate = document.getElementById('departureDate').value;
            const departureTime = document.getElementById('departureTime').value;
            const route = `${fromCity}-${toCity}`;
            
            if (!busCompany || !route || !departureDate || !departureTime) return;
            
            const reservationKey = `${busCompany}-${busType}-${route}-${departureDate}-${departureTime}`;
            const allReservations = JSON.parse(localStorage.getItem(SEAT_RESERVATION_KEY) || '{}');
            
            if (allReservations[reservationKey]) {
                const reservation = allReservations[reservationKey];
                
                // Check if reservation is still valid and belongs to this session
                if (reservation.expires > Date.now() && reservation.sessionId === getSessionId()) {
                    selectedSeats = reservation.seats || [];
                    console.log('📥 Loaded seat reservation:', reservationKey, selectedSeats);
                    return selectedSeats;
                } else {
                    // Remove expired reservation
                    delete allReservations[reservationKey];
                    localStorage.setItem(SEAT_RESERVATION_KEY, JSON.stringify(allReservations));
                }
            }
            
            return [];
        }

        function getReservedSeatsByOthers() {
            const busCompany = document.getElementById('busCompany').value;
            const busType = document.getElementById('busType').value;
            const fromCity = document.getElementById('fromCity').value;
            const toCity = document.getElementById('toCity').value;
            const departureDate = document.getElementById('departureDate').value;
            const departureTime = document.getElementById('departureTime').value;
            const route = `${fromCity}-${toCity}`;
            
            if (!busCompany || !route || !departureDate || !departureTime) return [];
            
            const reservationKey = `${busCompany}-${busType}-${route}-${departureDate}-${departureTime}`;
            const allReservations = JSON.parse(localStorage.getItem(SEAT_RESERVATION_KEY) || '{}');
            const currentSessionId = getSessionId();
            const reservedSeats = [];
            
            // Check all reservations for this route
            Object.keys(allReservations).forEach(key => {
                if (key === reservationKey) {
                    const reservation = allReservations[key];
                    // Only consider reservations from other sessions that haven't expired
                    if (reservation.expires > Date.now() && reservation.sessionId !== currentSessionId) {
                        reservedSeats.push(...(reservation.seats || []));
                    }
                }
            });
            
            return reservedSeats;
        }

        function cleanupExpiredReservations(reservations) {
            const now = Date.now();
            Object.keys(reservations).forEach(key => {
                if (reservations[key].expires < now) {
                    delete reservations[key];
                }
            });
        }

        function getSessionId() {
            let sessionId = sessionStorage.getItem('swiftbus_session_id');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('swiftbus_session_id', sessionId);
            }
            return sessionId;
        }

        function clearSeatReservation() {
            const busCompany = document.getElementById('busCompany').value;
            const busType = document.getElementById('busType').value;
            const fromCity = document.getElementById('fromCity').value;
            const toCity = document.getElementById('toCity').value;
            const departureDate = document.getElementById('departureDate').value;
            const departureTime = document.getElementById('departureTime').value;
            const route = `${fromCity}-${toCity}`;
            
            if (!busCompany || !route || !departureDate || !departureTime) return;
            
            const reservationKey = `${busCompany}-${busType}-${route}-${departureDate}-${departureTime}`;
            const allReservations = JSON.parse(localStorage.getItem(SEAT_RESERVATION_KEY) || '{}');
            
            if (allReservations[reservationKey] && allReservations[reservationKey].sessionId === getSessionId()) {
                delete allReservations[reservationKey];
                localStorage.setItem(SEAT_RESERVATION_KEY, JSON.stringify(allReservations));
                console.log('🗑️ Cleared seat reservation:', reservationKey);
            }
        }

        // Booking state
        let currentStep = 1;
        let selectedSeats = []; // Initialize as empty array
        let selectedPaymentMethod = null;
        let isLoadingData = false; // Flag to track data loading state
        const seatPrices = {
            'premium-ac': 450,
            'standard-ac': 350,
            'luxury': 550,
            'standard': 300,
            'economy': 250
        };
        const serviceFee = 25;
        const taxRate = 0.1; // 10%

        // Bus companies mapping
        const busCompanies = {
            'selam-bus': { name: 'Selam Bus', color: '#667eea' },
            'abay-bus': { name: 'Abay Bus', color: '#764ba2' },
            'ethio-bus': { name: 'Ethio Bus', color: '#4CAF50' },
            'habesha-bus': { name: 'Habesha Bus', color: '#FF9800' }
        };

        // Bus types mapping
        const busTypes = {
            'premium-ac': 'Premium AC Bus',
            'standard-ac': 'Standard AC Bus',
            'luxury': 'Luxury Bus',
            'standard': 'Standard Bus',
            'economy': 'Economy Bus'
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Book-ticket page initializing...');
            
            // Clean up expired reservations on page load
            const allReservations = JSON.parse(localStorage.getItem(SEAT_RESERVATION_KEY) || '{}');
            cleanupExpiredReservations(allReservations);
            localStorage.setItem(SEAT_RESERVATION_KEY, JSON.stringify(allReservations));
            
            // Set tomorrow's date as default FIRST
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const formattedDate = tomorrow.toISOString().split('T')[0];
            document.getElementById('departureDate').value = formattedDate;
            document.getElementById('departureDate').min = formattedDate;
            
            // Check URL parameters for step navigation
            checkUrlParameters();
            
            // Initialize form and setup event listeners
            initializeForm();
            setupEventListeners();
            
            // Load data from previous page BEFORE other updates
            loadSearchData();
            setupDynamicBackButton();
            
            // Update UI components after data is loaded
            setTimeout(() => {
                updateProgress();
                updateSummary();
                updateBusCompanyInfo();
                generateSeatMap();
                
                // Clear any validation errors and update navigation
                clearValidationErrors();
                updateNavigationButtons();
                
                console.log('✅ Book-ticket page initialization complete');
            }, 100);
            
            // Also update navigation buttons immediately after a short delay to ensure form is populated
            setTimeout(() => {
                console.log('🔄 Final navigation button update...');
                updateNavigationButtons();
            }, 200);
            
            // Add a safety check to ensure Next button is visible
            setTimeout(() => {
                const nextBtn = document.getElementById('nextBtn');
                if (nextBtn && currentStep < 4 && nextBtn.style.display === 'none') {
                    console.log('🚨 Safety check: Next button was hidden, making it visible');
                    nextBtn.style.display = 'inline-flex';
                    updateNavigationButtons();
                }
            }, 500);
        });

        // Check URL parameters for navigation
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const stepParam = urlParams.get('step');
            const returnParam = urlParams.get('return');
            
            if (stepParam) {
                const targetStep = parseInt(stepParam);
                if (targetStep >= 1 && targetStep <= 4) {
                    console.log('🔗 URL parameter detected: jumping to step', targetStep);
                    currentStep = targetStep;
                    
                    // **ENHANCED: Handle return from payment with proper state restoration**
                    if (targetStep === 4 && returnParam === 'payment') {
                        console.log('🔙 Returning from payment page - restoring state');
                        loadPaymentReturnData();
                        
                        // **CRITICAL: Ensure we show step 4 with all data intact**
                        setTimeout(() => {
                            showStep(4);
                            updateNavigationButtons();
                            updateSummary();
                            
                            // **NEW: Restore payment method selection if it was made**
                            const storedReturnStep = localStorage.getItem('swiftbus_return_step');
                            if (storedReturnStep === '4') {
                                restorePaymentMethodSelection();
                                localStorage.removeItem('swiftbus_return_step');
                            }
                        }, 100);
                    } else if (targetStep === 4) {
                        // Regular step 4 navigation
                        loadPaymentReturnData();
                    }
                    
                    // Clear URL parameters to avoid confusion on refresh
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }
            }
        }
        
        // **NEW: Restore payment method selection state**
        function restorePaymentMethodSelection() {
            try {
                const paymentData = JSON.parse(localStorage.getItem('swiftbus_payment_data') || '{}');
                
                if (paymentData.payment_method_selected) {
                    console.log('🔄 Restoring payment method selection:', paymentData.payment_method_selected);
                    
                    // Restore the selected payment method UI state
                    const paymentOptions = document.querySelectorAll('.payment-option');
                    paymentOptions.forEach(option => {
                        option.classList.remove('selected');
                        if (option.getAttribute('data-method') === paymentData.payment_method_selected) {
                            option.classList.add('selected');
                        }
                    });
                    
                    // Set the hidden input
                    const paymentMethodInput = document.getElementById('paymentMethod');
                    if (paymentMethodInput) {
                        paymentMethodInput.value = paymentData.payment_method_selected;
                    }
                    
                    selectedPaymentMethod = paymentData.payment_method_selected;
                    
                    console.log('✅ Payment method selection restored');
                }
            } catch (error) {
                console.error('❌ Error restoring payment method selection:', error);
            }
        }

        // Load data when returning from payment page
        function loadPaymentReturnData() {
            try {
                const paymentData = JSON.parse(localStorage.getItem('swiftbus_payment_data') || '{}');
                
                if (paymentData && Object.keys(paymentData).length > 0) {
                    console.log('📥 Loading enhanced data from payment return:', paymentData);
                    
                    // **ENHANCED: Check if this is a return from payment page**
                    if (paymentData.returning_from_payment) {
                        console.log('🔙 Detected return from payment page - full state restoration');
                        
                        // Remove the return flag to prevent confusion
                        delete paymentData.returning_from_payment;
                        localStorage.setItem('swiftbus_payment_data', JSON.stringify(paymentData));
                    }
                    
                    // Populate form fields from payment data
                    if (paymentData.bus_company) {
                        document.getElementById('busCompany').value = paymentData.bus_company;
                    }
                    if (paymentData.bus_type) {
                        document.getElementById('busType').value = paymentData.bus_type;
                    }
                    if (paymentData.from_city) {
                        document.getElementById('fromCity').value = paymentData.from_city;
                    }
                    if (paymentData.to_city) {
                        document.getElementById('toCity').value = paymentData.to_city;
                    }
                    if (paymentData.departure_date) {
                        document.getElementById('departureDate').value = paymentData.departure_date;
                    }
                    if (paymentData.departure_time) {
                        document.getElementById('departureTime').value = paymentData.departure_time;
                    }
                    if (paymentData.passenger_count) {
                        document.getElementById('passengerCount').value = paymentData.passenger_count.toString();
                    }
                    
                    // Populate passenger details
                    if (paymentData.passenger_details) {
                        const details = paymentData.passenger_details;
                        if (details.fullName) document.getElementById('fullName').value = details.fullName;
                        if (details.email) document.getElementById('email').value = details.email;
                        if (details.phone) document.getElementById('phone').value = details.phone;
                        if (details.nationality) document.getElementById('nationality').value = details.nationality;
                        if (details.idNumber) document.getElementById('idNumber').value = details.idNumber;
                        if (details.ageGroup) document.getElementById('ageGroup').value = details.ageGroup;
                        if (details.specialRequirements) document.getElementById('specialRequirements').value = details.specialRequirements;
                    }
                    
                    // **ENHANCED: Restore selected seats with proper validation**
                    if (paymentData.selected_seats && Array.isArray(paymentData.selected_seats)) {
                        selectedSeats = [...paymentData.selected_seats];
                        console.log('🪑 Restored selected seats:', selectedSeats);
                        
                        // **NEW: Regenerate seat map to show current selections**
                        setTimeout(() => {
                            generateSeatMap();
                        }, 200);
                    }
                    
                    // **NEW: Restore payment method selection if available**
                    if (paymentData.payment_method_selected) {
                        selectedPaymentMethod = paymentData.payment_method_selected;
                        console.log('💳 Restored payment method:', selectedPaymentMethod);
                    }
                    
                    console.log('✅ Enhanced payment return data loaded successfully');
                }
            } catch (error) {
                console.error('❌ Error loading payment return data:', error);
            }
        }

        // Setup dynamic back button
        function setupDynamicBackButton() {
            const backBtn = document.getElementById('backBtn');
            const backBtnText = document.getElementById('backBtnText');
            
            // Check referrer to determine where user came from
            const referrer = document.referrer;
            let backText = 'Back';
            
            if (referrer) {
                if (referrer.includes('search.html')) {
                    backText = 'Back to Search';
                } else if (referrer.includes('index.html')) {
                    backText = 'Back to Home';
                } else if (referrer.includes('routes.html')) {
                    backText = 'Back to Routes';
                } else if (referrer.includes('my-tickets.html')) {
                    backText = 'Back to My Tickets';
                } else {
                    backText = 'Back';
                }
            }
            
            // Use history.back() for better navigation
            backBtn.onclick = function(e) {
                e.preventDefault();
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    // Fallback to home if no history
                    window.location.href = 'index.html';
                }
            };
            
            backBtnText.textContent = backText;
            
            console.log('Back button set to:', backText);
        }

        // Load search data from previous page
        function loadSearchData() {
            try {
                console.log('📥 Loading search data from previous page...');
                isLoadingData = true; // Set flag to prevent seat clearing
                
                let searchData = null;
                
                // Try to get search data from localStorage (multiple possible keys)
                const searchDataStr = localStorage.getItem('swiftbus_search_data');
                const bookingDataStr = localStorage.getItem('swiftbus_current_booking');
                
                console.log('🔍 Checking localStorage:');
                console.log('  - swiftbus_search_data:', searchDataStr ? 'Found' : 'Not found');
                console.log('  - swiftbus_current_booking:', bookingDataStr ? 'Found' : 'Not found');
                
                // Try search data first (from index.html)
                if (searchDataStr) {
                    const rawSearchData = JSON.parse(searchDataStr);
                    searchData = {
                        from: rawSearchData.from,
                        to: rawSearchData.to,
                        date: rawSearchData.date,
                        passengers: rawSearchData.passengers || 1
                    };
                    console.log('✅ Using search data from index.html:', searchData);
                }
                // Try booking data (from search.html)
                else if (bookingDataStr) {
                    const rawBookingData = JSON.parse(bookingDataStr);
                    searchData = {
                        from: rawBookingData.from,
                        to: rawBookingData.to,
                        date: rawBookingData.date,
                        passengers: rawBookingData.passengers || 1,
                        busCompany: rawBookingData.busCompany,
                        busType: rawBookingData.type,
                        departureTime: rawBookingData.departure
                    };
                    console.log('✅ Using booking data from search.html:', searchData);
                }
                
                if (searchData) {
                    console.log('📝 Populating form fields...');
                    
                    // Apply bus company if available
                    if (searchData.busCompany) {
                        const companySelect = document.getElementById('busCompany');
                        const companyValue = getCompanyValue(searchData.busCompany);
                        if (companySelect && companyValue) {
                            companySelect.value = companyValue;
                            hideError('busCompany');
                            console.log('  ✅ Set bus company:', companyValue, '(from:', searchData.busCompany + ')');
                        }
                    }
                    
                    // Apply bus type if available
                    if (searchData.busType) {
                        const typeSelect = document.getElementById('busType');
                        const typeValue = getBusTypeValue(searchData.busType);
                        if (typeSelect && typeValue) {
                            typeSelect.value = typeValue;
                            hideError('busType');
                            console.log('  ✅ Set bus type:', typeValue, '(from:', searchData.busType + ')');
                        }
                    }
                    
                    // Apply the search data to form fields
                    if (searchData.from) {
                        const fromSelect = document.getElementById('fromCity');
                        const fromValue = getCityValue(searchData.from);
                        
                        if (fromSelect && fromValue) {
                            fromSelect.value = fromValue;
                            hideError('fromCity');
                            console.log('  ✅ Set from city:', fromValue, '(from:', searchData.from + ')');
                        }
                    }
                    
                    if (searchData.to) {
                        const toSelect = document.getElementById('toCity');
                        const toValue = getCityValue(searchData.to);
                        
                        if (toSelect && toValue) {
                            toSelect.value = toValue;
                            hideError('toCity');
                            console.log('  ✅ Set to city:', toValue, '(from:', searchData.to + ')');
                        }
                    }
                    
                    if (searchData.date) {
                        const dateInput = document.getElementById('departureDate');
                        if (dateInput) {
                            dateInput.value = searchData.date;
                            hideError('departureDate');
                            console.log('  ✅ Set date:', searchData.date);
                        }
                    }
                    
                    if (searchData.departureTime) {
                        const timeSelect = document.getElementById('departureTime');
                        const timeValue = getTimeValue(searchData.departureTime);
                        if (timeSelect && timeValue) {
                            timeSelect.value = timeValue;
                            hideError('departureTime');
                            console.log('  ✅ Set time:', timeValue, '(from:', searchData.departureTime + ')');
                        }
                    }
                    
                    if (searchData.passengers) {
                        const passengerSelect = document.getElementById('passengerCount');
                        if (passengerSelect) {
                            passengerSelect.value = searchData.passengers.toString();
                            hideError('passengerCount');
                            console.log('  ✅ Set passengers:', searchData.passengers);
                        }
                    }
                    
                    // Clear the localStorage data after using it
                    localStorage.removeItem('swiftbus_search_data');
                    localStorage.removeItem('swiftbus_current_booking');
                    console.log('🗑️ Cleared localStorage data');
                    
                    // Immediately trigger form updates
                    console.log('🔄 Triggering form updates...');
                    updateSummary();
                    updateBusCompanyInfo();
                    triggerFormChangeEvents();
                    
                    // Force navigation button update after data loading
                    setTimeout(() => {
                        console.log('🔄 Navigation update after data loading...');
                        updateNavigationButtons();
                    }, 10);
                    
                    console.log('✅ Form populated successfully from search data');
                    
                    // Clear the loading flag
                    isLoadingData = false;
                    
                } else {
                    console.log('❌ No search data found in localStorage');
                    isLoadingData = false;
                    
                    // Ensure Next button is visible for manual entry
                    setTimeout(() => {
                        console.log('🔄 Updating navigation for manual entry...');
                        updateNavigationButtons();
                    }, 10);
                }
                
                // Also check URL parameters for company selection (from index.html bus company popup)
                const urlParams = new URLSearchParams(window.location.search);
                const companyParam = urlParams.get('company');
                
                if (companyParam) {
                    const companySelect = document.getElementById('busCompany');
                    const companyValue = getCompanyValue(companyParam);
                    if (companySelect && companyValue) {
                        companySelect.value = companyValue;
                        updateBusCompanyInfo();
                        console.log('✅ Set company from URL parameter:', companyValue);
                    }
                }
                
                // Clear the loading flag in case of error
                isLoadingData = false;
                
            } catch (error) {
                console.error('❌ Error loading search data:', error);
                isLoadingData = false;
            }
        }

        // Helper function to convert city names to form values
        function getCityValue(cityName) {
            if (!cityName) return null;
            
            const cityMapping = {
                // Standard mappings
                'Addis Ababa': 'addis-ababa',
                'Kombolcha': 'kombolcha', 
                'Bahirdar': 'bahirdar',
                'Dessie': 'dessie',
                'Adama': 'adama',
                'Hawasa': 'hawasa',
                'Arbaminch': 'arbaminch',
                'Gonder': 'gonder',
                'Mekele': 'mekele',
                'Jimma': 'jimma',
                
                // Alternative spellings and variations
                'Addis': 'addis-ababa',
                'Bahir Dar': 'bahirdar',
                'Bahar Dar': 'bahirdar',
                'Arba Minch': 'arbaminch',
                'Gondar': 'gonder',
                'Mekelle': 'mekele',
                'Hawassa': 'hawasa',
                'Awassa': 'hawasa',
                
                // Lowercase versions
                'addis ababa': 'addis-ababa',
                'kombolcha': 'kombolcha',
                'bahirdar': 'bahirdar',
                'dessie': 'dessie',
                'adama': 'adama',
                'hawasa': 'hawasa',
                'arbaminch': 'arbaminch',
                'gonder': 'gonder',
                'mekele': 'mekele',
                'jimma': 'jimma'
            };
            
            // Try exact match first
            if (cityMapping[cityName]) {
                return cityMapping[cityName];
            }
            
            // Try case-insensitive match
            const cityKey = Object.keys(cityMapping).find(key => 
                key.toLowerCase() === cityName.toLowerCase()
            );
            
            if (cityKey) {
                return cityMapping[cityKey];
            }
            
            // If no match, try to convert the name to a value
            return cityName.toLowerCase().replace(/\s+/g, '-');
        }

        // Helper function to convert company names to form values
        function getCompanyValue(companyName) {
            const companyMapping = {
                'Selam Bus': 'selam-bus',
                'Abay Bus': 'abay-bus', 
                'Ethio Bus': 'ethio-bus',
                'Habesha Bus': 'habesha-bus'
            };
            
            return companyMapping[companyName] || companyName.toLowerCase().replace(/\s+/g, '-');
        }

        // Helper function to convert bus type names to form values
        function getBusTypeValue(busTypeName) {
            const busTypeMapping = {
                'Premium AC Bus': 'premium-ac',
                'Standard AC Bus': 'standard-ac',
                'Luxury Bus': 'luxury',
                'Standard Bus': 'standard',
                'Economy Bus': 'economy',
                // Handle variations
                'Premium AC': 'premium-ac',
                'Standard AC': 'standard-ac',
                'Luxury': 'luxury',
                'Standard': 'standard',
                'Economy': 'economy'
            };
            
            return busTypeMapping[busTypeName] || busTypeName.toLowerCase().replace(/\s+/g, '-');
        }

        // Helper function to convert time formats
        function getTimeValue(timeString) {
            if (!timeString) return null;
            
            // Handle different time formats
            // "08:00 AM" → "08:00"
            // "8:00 AM" → "08:00"
            // "08:00" → "08:00"
            
            let time = timeString.toString().trim();
            
            // Remove AM/PM and normalize
            time = time.replace(/\s*(AM|PM|am|pm)\s*/g, '');
            
            // Ensure HH:MM format
            if (time.length === 4 && time.indexOf(':') === 1) {
                time = '0' + time; // "8:00" → "08:00"
            }
            
            // Map common times to form values
            const timeMapping = {
                '06:00': '06:00',
                '08:00': '08:00',
                '10:00': '10:00',
                '14:00': '14:00',
                '18:00': '18:00',
                '20:00': '20:00',
                '22:00': '22:00'
            };
            
            return timeMapping[time] || time;
        }

        // Trigger change events on form fields to update validation
        function triggerFormChangeEvents() {
            const fieldsToTrigger = ['busCompany', 'busType', 'fromCity', 'toCity', 'departureDate', 'departureTime', 'passengerCount'];
            
            console.log('🔄 Triggering change events for form validation...');
            
            fieldsToTrigger.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    // Create and dispatch change event
                    const changeEvent = new Event('change', { bubbles: true });
                    const inputEvent = new Event('input', { bubbles: true });
                    
                    field.dispatchEvent(changeEvent);
                    field.dispatchEvent(inputEvent);
                    
                    // Also clear any error state for this field
                    hideError(fieldId);
                    
                    console.log('  ✅ Triggered events for:', fieldId, 'value:', field.value);
                } else {
                    console.log('  ❌ Field not found or empty:', fieldId);
                }
            });
            
            // Immediately update navigation buttons after triggering events
            console.log('🔄 Updating navigation buttons after form events...');
            updateNavigationButtons();
            
            // Also update after a small delay to ensure all events are processed
            setTimeout(() => {
                console.log('🔄 Final navigation update after events...');
                updateNavigationButtons();
            }, 50);
        }

        // Clear all validation errors and update form state
        function clearValidationErrors() {
            hideAllErrors();
            
            // Remove error classes from all form controls
            document.querySelectorAll('.form-control.error').forEach(el => {
                el.classList.remove('error');
            });
            
            // Update navigation buttons to reflect current state
            updateNavigationButtons();
            
            console.log('✅ Cleared all validation errors');
        }

        function initializeForm() {
            // Show the appropriate step (either from URL parameter or default to 1)
            showStep(currentStep);
            setupFormValidation();
            
            // Ensure Next button is visible initially
            setTimeout(() => {
                const nextBtn = document.getElementById('nextBtn');
                if (nextBtn) {
                    nextBtn.style.display = 'inline-flex';
                    console.log('🔄 Ensured Next button is visible on initialization');
                }
                updateNavigationButtons();
            }, 50);
        }

        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show current step
            document.querySelector(`.form-section[data-step="${step}"]`).classList.add('active');
            
            // Update progress steps
            document.querySelectorAll('.progress-step').forEach(progressStep => {
                const stepNumber = parseInt(progressStep.getAttribute('data-step'));
                progressStep.classList.remove('active', 'completed');
                
                if (stepNumber < step) {
                    progressStep.classList.add('completed');
                } else if (stepNumber === step) {
                    progressStep.classList.add('active');
                }
            });
            
            // Update progress bar
            const progressFill = document.getElementById('progressFill');
            const progressPercentage = ((step - 1) / 3) * 100;
            progressFill.style.width = `${progressPercentage}%`;
            
            // Update navigation buttons
            updateNavigationButtons();
            
            // Update summary
            updateSummary();
        }

        function validateStep(step) {
            let isValid = true;
            
            // Hide all error messages first
            hideAllErrors();
            
            switch(step) {
                case 1:
                    const requiredFields1 = ['busCompany', 'busType', 'fromCity', 'toCity', 'departureDate', 'departureTime', 'passengerCount'];
                    
                    requiredFields1.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (!field || !field.value) {
                            showError(fieldId);
                            isValid = false;
                        }
                    });
                    
                    if (isValid) {
                        const fromCity = document.getElementById('fromCity').value;
                        const toCity = document.getElementById('toCity').value;
                        
                        if (fromCity === toCity) {
                            showError('toCity', 'Departure and destination cannot be the same!');
                            isValid = false;
                        }
                    }
                    break;
                    
                case 2:
                    const requiredFields2 = ['fullName', 'email', 'phone', 'idNumber'];
                    requiredFields2.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (!field || !field.value.trim()) {
                            showError(fieldId);
                            isValid = false;
                        }
                    });
                    
                    // Email validation
                    const email = document.getElementById('email').value.trim();
                    if (email && !isValidEmail(email)) {
                        showError('email', 'Please enter a valid email address!');
                        isValid = false;
                    }
                    
                    // Phone validation
                    const phone = document.getElementById('phone').value.trim();
                    if (phone && phone.replace(/\D/g, '').length < 9) {
                        showError('phone', 'Please enter a valid phone number!');
                        isValid = false;
                    }
                    
                    // ID Number validation
                    const idNumber = document.getElementById('idNumber').value.trim();
                    if (!idNumber) {
                        showError('idNumber', 'ID/Passport number is required!');
                        isValid = false;
                    } else if (idNumber.length < 5) {
                        showError('idNumber', 'ID/Passport number must be at least 5 characters!');
                        isValid = false;
                    }
                    break;
                    
                case 3:
                    const passengerCount = parseInt(document.getElementById('passengerCount').value);
                    
                    // Ensure selectedSeats is always an array
                    if (!selectedSeats || !Array.isArray(selectedSeats)) {
                        selectedSeats = [];
                    }
                    
                    if (selectedSeats.length === 0) {
                        isValid = false;
                    } else if (selectedSeats.length !== passengerCount) {
                        isValid = false;
                    }
                    break;
                    
                case 4:
                    // Step 4 validation removed - users must go to payment page
                    isValid = true; // Always valid since payment is handled separately
                    break;
            }
            
            return isValid;
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showError(fieldId, message = null) {
            const errorElement = document.getElementById(`${fieldId}Error`);
            if (errorElement) {
                if (message) errorElement.textContent = message;
                errorElement.style.display = 'block';
                const input = document.getElementById(fieldId);
                if (input) input.classList.add('error');
            }
        }

        function hideError(fieldId) {
            const errorElement = document.getElementById(`${fieldId}Error`);
            if (errorElement) {
                errorElement.style.display = 'none';
                const input = document.getElementById(fieldId);
                if (input) input.classList.remove('error');
            }
        }

        function hideAllErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.form-control.error').forEach(el => {
                el.classList.remove('error');
            });
        }

        function setupFormValidation() {
            // Real-time validation for step 1
            const step1Inputs = ['busCompany', 'busType', 'fromCity', 'toCity', 'departureDate', 'departureTime', 'passengerCount'];
            step1Inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        hideError(id);
                        if (id === 'busCompany' || id === 'busType') {
                            updateBusCompanyInfo();
                        }
                        if (id === 'toCity') {
                            const fromCity = document.getElementById('fromCity').value;
                            const toCity = this.value;
                            if (fromCity && toCity && fromCity === toCity) {
                                showError('toCity', 'Departure and destination cannot be the same!');
                            }
                        }
                        // Regenerate seat map when relevant fields change
                        if (['busCompany', 'busType', 'fromCity', 'toCity', 'departureDate', 'departureTime'].includes(id)) {
                            onFormValueChange();
                        }
                        updateNavigationButtons();
                    });
                }
            });

            // Real-time validation for step 2
            const step2Inputs = ['fullName', 'email', 'phone'];
            step2Inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    hideError(id);
                    updateNavigationButtons();
                });
            });
        }

        async function generateSeatMap() {
            const seatMap = document.getElementById('seatMap');
            seatMap.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading seats...</div>';
            
            try {
                // Get current form values
                const busCompany = document.getElementById('busCompany').value;
                const busType = document.getElementById('busType').value;
                const fromCity = document.getElementById('fromCity').value;
                const toCity = document.getElementById('toCity').value;
                const departureDate = document.getElementById('departureDate').value;
                const departureTime = document.getElementById('departureTime').value;
                
                if (!busCompany || !fromCity || !toCity || !departureDate || !departureTime) {
                    console.log('❌ Form incomplete, using default seat map');
                    generateDefaultSeatMap();
                    return;
                }
                
                const route = `${fromCity}-${toCity}`;
                
                console.log('🔍 Loading seats from API:', { busCompany, busType, route, departureDate, departureTime });
                
                // Get available seats from backend
                const response = await swiftBusAPI.getAvailableSeats(busCompany, busType, route, departureDate, departureTime);
                
                console.log('📡 Raw API Response:', response);
                
                // Check if we got a successful response with seat data
                if (response && response.success === true && response.data && Array.isArray(response.data.seats) && response.data.seats.length > 0) {
                    console.log('✅ Using database seat data:', response.data.seats.length, 'seats');
                    generateSeatMapFromData(response.data.seats);
                } else {
                    console.log('❌ API failed or no seat data:');
                    console.log('  - Success:', response?.success);
                    console.log('  - Has data:', !!response?.data);
                    console.log('  - Has seats:', Array.isArray(response?.data?.seats));
                    console.log('  - Seats count:', response?.data?.seats?.length);
                    console.log('  - Error message:', response?.message);
                    console.log('🔄 Falling back to default seat map');
                    generateDefaultSeatMap();
                }
                
            } catch (error) {
                console.error('❌ Error loading seats:', error);
                console.log('🔄 Falling back to default seat map due to error');
                generateDefaultSeatMap();
            }
        }

        function generateSeatMapFromData(seats) {
            const seatMap = document.getElementById('seatMap');
            seatMap.innerHTML = '';
            
            console.log('🎯 Generating seat map from database data:', seats);
            
            // Load previously selected seats from localStorage
            const previouslySelected = loadSelectedSeatsFromStorage();
            selectedSeats = previouslySelected;
            
            // Get seats reserved by other users
            const reservedByOthers = getReservedSeatsByOthers();
            
            console.log('📥 Previously selected seats:', previouslySelected);
            console.log('🔒 Reserved by others:', reservedByOthers);
            
            seats.forEach(seatData => {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.textContent = seatData.number;
                seat.setAttribute('data-seat', seatData.number);
                
                // Set seat status based on database data and localStorage reservations
                const isReservedByOthers = reservedByOthers.includes(seatData.number);
                const isPreviouslySelected = previouslySelected.includes(seatData.number);
                
                if (!seatData.available || isReservedByOthers) {
                    seat.classList.add('occupied');
                    console.log(`💺 Seat ${seatData.number}: OCCUPIED (DB: ${!seatData.available}, Reserved: ${isReservedByOthers})`);
                } else {
                    seat.classList.add('available');
                    console.log(`💺 Seat ${seatData.number}: AVAILABLE (${seatData.type})`);
                    
                    // Add special seat types
                    if (seatData.type === 'women-only') {
                        seat.classList.add('women-only');
                    } else if (seatData.type === 'accessible') {
                        seat.classList.add('accessible');
                    }
                }
                
                // Mark previously selected seats
                if (isPreviouslySelected) {
                    seat.classList.add('selected');
                    console.log(`✅ Seat ${seatData.number}: RESTORED SELECTION`);
                }
                
                seat.addEventListener('click', function() {
                    if (this.classList.contains('occupied')) return;
                    
                    const seatNumber = parseInt(this.getAttribute('data-seat'));
                    const passengerCount = parseInt(document.getElementById('passengerCount').value);
                    
                    if (this.classList.contains('selected')) {
                        // Deselect seat
                        this.classList.remove('selected');
                        selectedSeats = selectedSeats.filter(s => s !== seatNumber);
                    } else {
                        // Check if we can select more seats
                        if (selectedSeats.length >= passengerCount) {
                            showNotification(`You can only select ${passengerCount} seat(s) for ${passengerCount} passenger(s).`, 'warning');
                            return;
                        }
                        
                        // Select seat
                        this.classList.add('selected');
                        selectedSeats.push(seatNumber);
                        selectedSeats.sort((a, b) => a - b);
                    }
                    
                    // Save selection to localStorage
                    saveSelectedSeatsToStorage();
                    
                    updateSelectedSeatsDisplay();
                    updateNavigationButtons();
                    updateSummary();
                });
                
                seatMap.appendChild(seat);
            });
            
            // Update displays with restored selection
            updateSelectedSeatsDisplay();
            updateNavigationButtons();
            updateSummary();
            
            console.log('✅ Seat map generated successfully with', seats.length, 'seats');
        }

        function generateDefaultSeatMap() {
            const seatMap = document.getElementById('seatMap');
            seatMap.innerHTML = '';
            
            console.log('🔄 Generating default seat map (fallback) - Using localStorage reservations');
            
            // Load previously selected seats from localStorage
            const previouslySelected = loadSelectedSeatsFromStorage();
            selectedSeats = previouslySelected;
            
            // Get seats reserved by other users
            const reservedByOthers = getReservedSeatsByOthers();
            
            console.log('📥 Previously selected seats:', previouslySelected);
            console.log('🔒 Reserved by others:', reservedByOthers);
            
            // Generate seats based on bus type
            const busType = document.getElementById('busType').value;
            const seatCount = getSeatCountForBusType(busType);
            
            for (let i = 1; i <= seatCount; i++) {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.textContent = i;
                seat.setAttribute('data-seat', i);
                
                // Check if seat is reserved by others
                const isReservedByOthers = reservedByOthers.includes(i);
                const isPreviouslySelected = previouslySelected.includes(i);
                
                if (isReservedByOthers) {
                    seat.classList.add('occupied');
                    console.log(`💺 Seat ${i}: OCCUPIED (Reserved by others)`);
                } else {
                    seat.classList.add('available');
                    
                    // Designate special seats
                    if (i <= 4 || i % 5 === 0) {
                        seat.classList.add('women-only');
                    } else if (i === 5 || i === 6) {
                        seat.classList.add('accessible');
                    }
                }
                
                // Mark previously selected seats
                if (isPreviouslySelected) {
                    seat.classList.add('selected');
                    console.log(`✅ Seat ${i}: RESTORED SELECTION`);
                }
                
                seat.addEventListener('click', function() {
                    if (this.classList.contains('occupied')) return;
                    
                    const seatNumber = parseInt(this.getAttribute('data-seat'));
                    const passengerCount = parseInt(document.getElementById('passengerCount').value);
                    
                    if (this.classList.contains('selected')) {
                        // Deselect seat
                        this.classList.remove('selected');
                        selectedSeats = selectedSeats.filter(s => s !== seatNumber);
                    } else {
                        // Check if we can select more seats
                        if (selectedSeats.length >= passengerCount) {
                            showNotification(`You can only select ${passengerCount} seat(s) for ${passengerCount} passenger(s).`, 'warning');
                            return;
                        }
                        
                        // Select seat
                        this.classList.add('selected');
                        selectedSeats.push(seatNumber);
                        selectedSeats.sort((a, b) => a - b);
                    }
                    
                    // Save selection to localStorage
                    saveSelectedSeatsToStorage();
                    
                    updateSelectedSeatsDisplay();
                    updateNavigationButtons();
                    updateSummary();
                });
                
                seatMap.appendChild(seat);
            }
            
            // Update displays with restored selection
            updateSelectedSeatsDisplay();
            updateNavigationButtons();
            updateSummary();
            
            console.log('✅ Default seat map generated with', seatCount, 'seats (Using localStorage)');
        }

        function getSeatCountForBusType(busType) {
            const seatCounts = {
                'premium-ac': 45,
                'standard-ac': 50,
                'luxury': 40,
                'standard': 55,
                'economy': 60
            };
            return seatCounts[busType] || 45;
        }

        // Regenerate seat map when form values change
        function onFormValueChange() {
            // Only clear selection if this is not during data loading
            if (!isLoadingData) {
                console.log('🔄 Form values changed by user - clearing seat selection');
                // Clear current selection when route/date/time changes
                selectedSeats = [];
                clearSeatReservation();
            } else {
                console.log('🔄 Form values changed during data loading - keeping seat selection');
            }
            
            generateSeatMap();
            updateSummary();
        }

        function updateSelectedSeatsDisplay() {
            const selectedSeatsList = document.getElementById('selectedSeatsList');
            const seatPriceElement = document.getElementById('seatPrice');
            
            // Ensure selectedSeats is always an array
            if (!selectedSeats || !Array.isArray(selectedSeats)) {
                selectedSeats = [];
            }
            
            if (selectedSeats.length === 0) {
                selectedSeatsList.innerHTML = '<p style="color: var(--gray); text-align: center;">No seats selected yet</p>';
                seatPriceElement.textContent = 'ETB 0';
            } else {
                selectedSeatsList.innerHTML = `
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${selectedSeats.map(seat => `
                            <span style="background: var(--primary); color: white; padding: 5px 10px; border-radius: 5px;">
                                Seat ${seat}
                            </span>
                        `).join('')}
                    </div>
                `;
                const busType = document.getElementById('busType').value;
                const pricePerSeat = seatPrices[busType] || 350;
                const totalSeatPrice = selectedSeats.length * pricePerSeat;
                seatPriceElement.textContent = `ETB ${totalSeatPrice}`;
            }
        }

        function updateBusCompanyInfo() {
            const companySelect = document.getElementById('busCompany');
            const typeSelect = document.getElementById('busType');
            
            const companyId = companySelect.value;
            const companyInfo = busCompanies[companyId] || busCompanies['selam-bus'];
            const busType = busTypes[typeSelect.value] || 'Premium AC Bus';
            
            // Update banner
            document.getElementById('selectedCompanyName').textContent = companyInfo.name;
            document.getElementById('selectedBusType').textContent = busType;
            
            // Update banner background color
            const banner = document.querySelector('.bus-selection-banner');
            if (companyInfo.color) {
                banner.style.background = `linear-gradient(135deg, ${companyInfo.color} 0%, ${adjustColor(companyInfo.color, -20)} 100%)`;
            }
            
            updateSummary();
        }

        function adjustColor(color, amount) {
            let usePound = false;
            if (color[0] === "#") {
                color = color.slice(1);
                usePound = true;
            }
            const num = parseInt(color, 16);
            let r = (num >> 16) + amount;
            if (r > 255) r = 255;
            else if (r < 0) r = 0;
            let b = ((num >> 8) & 0x00FF) + amount;
            if (b > 255) b = 255;
            else if (b < 0) b = 0;
            let g = (num & 0x0000FF) + amount;
            if (g > 255) g = 255;
            else if (g < 0) g = 0;
            return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16);
        }

        function updateSummary() {
            // Update bus company and type info in banner
            const companySelect = document.getElementById('busCompany');
            const typeSelect = document.getElementById('busType');
            const companyInfo = busCompanies[companySelect.value] || busCompanies['selam-bus'];
            const busType = busTypes[typeSelect.value] || 'Premium AC Bus';
            
            document.getElementById('selectedCompanyName').textContent = companyInfo.name;
            document.getElementById('selectedBusType').textContent = busType;
            
            // Update confirmation modal booking amount
            const pricePerSeat = seatPrices[typeSelect.value] || 350;
            const seatCount = (selectedSeats && selectedSeats.length) || 1;
            const baseFare = seatCount * pricePerSeat;
            const tax = baseFare * taxRate;
            const total = baseFare + serviceFee + tax;
            
            document.getElementById('bookingAmount').textContent = `ETB ${Math.round(total)}`;
        }

        function updateProgress() {
            const progressFill = document.getElementById('progressFill');
            const progressPercentage = ((currentStep - 1) / 3) * 100;
            progressFill.style.width = `${progressPercentage}%`;
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            console.log('🔘 Updating navigation buttons for step', currentStep);
            
            // Ensure buttons exist
            if (!nextBtn) {
                console.error('❌ Next button not found!');
                return;
            }
            
            // Previous button
            prevBtn.disabled = currentStep === 1;
            
            // Next button - hide on step 4 since payment is separate
            if (currentStep === 4) {
                nextBtn.style.display = 'none';
                console.log('🔘 Step 4: Next button hidden (payment step)');
            } else {
                nextBtn.style.display = 'inline-flex';
                
                // Validate current step silently (don't show errors)
                const currentStepValid = validateStepSilently(currentStep);
                nextBtn.disabled = !currentStepValid;
                
                console.log('🔘 Step', currentStep, 'validation result:', currentStepValid);
                console.log('🔘 Next button', currentStepValid ? 'ENABLED' : 'DISABLED');
                console.log('🔘 Next button display:', nextBtn.style.display);
                console.log('🔘 Next button disabled:', nextBtn.disabled);
                
                // Debug current form values for step 1
                if (currentStep === 1) {
                    console.log('📊 Current form values:');
                    console.log('  Bus Company:', document.getElementById('busCompany').value);
                    console.log('  Bus Type:', document.getElementById('busType').value);
                    console.log('  From City:', document.getElementById('fromCity').value);
                    console.log('  To City:', document.getElementById('toCity').value);
                    console.log('  Date:', document.getElementById('departureDate').value);
                    console.log('  Time:', document.getElementById('departureTime').value);
                    console.log('  Passengers:', document.getElementById('passengerCount').value);
                }
            }
        }

        // Validate step without showing error messages (for navigation button updates)
        function validateStepSilently(step) {
            console.log('🔍 Silent validation for step', step + '...');
            
            switch(step) {
                case 1:
                    const requiredFields1 = ['busCompany', 'busType', 'fromCity', 'toCity', 'departureDate', 'departureTime', 'passengerCount'];
                    for (let fieldId of requiredFields1) {
                        const field = document.getElementById(fieldId);
                        if (!field || !field.value) {
                            console.log('  Silent check', fieldId + ':', field ? `"${field.value}"` : 'null', '(INVALID)');
                            return false;
                        } else {
                            console.log('  Silent check', fieldId + ':', `"${field.value}"`, '(VALID)');
                        }
                    }
                    
                    const fromCity = document.getElementById('fromCity').value;
                    const toCity = document.getElementById('toCity').value;
                    
                    if (fromCity === toCity) {
                        console.log('❌ Silent validation failed: same from/to city');
                        return false;
                    }
                    break;
                    
                case 2:
                    const requiredFields2 = ['fullName', 'email', 'phone'];
                    for (let fieldId of requiredFields2) {
                        const field = document.getElementById(fieldId);
                        if (!field.value.trim()) {
                            console.log('❌ Silent validation failed on field:', fieldId);
                            return false;
                        }
                    }
                    
                    // Email validation
                    const email = document.getElementById('email').value.trim();
                    if (email && !isValidEmail(email)) {
                        console.log('❌ Silent validation failed: invalid email');
                        return false;
                    }
                    
                    // Phone validation
                    const phone = document.getElementById('phone').value.trim();
                    if (phone && phone.replace(/\D/g, '').length < 9) {
                        console.log('❌ Silent validation failed: invalid phone');
                        return false;
                    }
                    break;
                    
                case 3:
                    const passengerCount = parseInt(document.getElementById('passengerCount').value);
                    
                    // Ensure selectedSeats is always an array
                    if (!selectedSeats || !Array.isArray(selectedSeats)) {
                        selectedSeats = [];
                    }
                    
                    if (selectedSeats.length === 0 || selectedSeats.length !== passengerCount) {
                        console.log('❌ Silent validation failed: seat selection mismatch');
                        return false;
                    }
                    break;
                    
                case 4:
                    return true; // Always valid since payment is handled separately
            }
            
            console.log('✅ Silent validation passed for step', step);
            return true;
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            document.getElementById('paymentMethod').value = method;
            hideError('paymentMethod');
            
            // Update UI
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`.payment-option[data-method="${method}"]`).classList.add('selected');
            
            updateNavigationButtons();
        }

        function redirectToPayment(method) {
            // First validate all steps
            for (let step = 1; step <= 3; step++) {
                if (!validateStep(step)) {
                    showStep(step);
                    return;
                }
            }
            
            // Validate terms agreement
            if (!document.getElementById('termsAgreement').checked) {
                showError('terms');
                return;
            }
            
            selectPaymentMethod(method);
            
            // Show loading state
            const paymentButtons = document.querySelectorAll('.pay-now-btn');
            paymentButtons.forEach(btn => {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                btn.disabled = true;
            });
            
            // Create booking in database first
            createBookingInDatabase(method);
        }

        // Create booking in database before payment
        async function createBookingInDatabase(paymentMethod) {
            try {
                console.log('🚀 Starting booking creation process...');
                
                // Validate all required fields before creating booking
                const requiredFields = {
                    'fromCity': 'From City',
                    'toCity': 'To City', 
                    'departureDate': 'Departure Date',
                    'departureTime': 'Departure Time',
                    'busCompany': 'Bus Company',
                    'busType': 'Bus Type',
                    'passengerCount': 'Passenger Count',
                    'fullName': 'Full Name',
                    'email': 'Email',
                    'phone': 'Phone',
                    'nationality': 'Nationality',
                    'idNumber': 'ID Number',
                    'ageGroup': 'Age Group'
                };
                
                const missingFields = [];
                for (const [fieldId, fieldName] of Object.entries(requiredFields)) {
                    const element = document.getElementById(fieldId);
                    if (!element) {
                        console.error(`❌ Element not found: ${fieldId}`);
                        missingFields.push(`${fieldName} (element not found)`);
                    } else if (!element.value || element.value.trim() === '') {
                        console.error(`❌ Field empty: ${fieldId} = "${element.value}"`);
                        missingFields.push(fieldName);
                    } else {
                        console.log(`✅ Field OK: ${fieldId} = "${element.value}"`);
                    }
                }
                
                if (missingFields.length > 0) {
                    console.error('❌ Validation failed. Missing fields:', missingFields);
                    showNotification(`Please fill in the following required fields: ${missingFields.join(', ')}`, 'error');
                    return;
                }
                
                // Validate selected seats
                if (!selectedSeats || selectedSeats.length === 0) {
                    console.error('❌ No seats selected');
                    showNotification('Please select at least one seat', 'error');
                    return;
                }
                
                console.log('✅ All validation passed. Creating booking...');
                
                // **ENHANCED: Calculate total with error handling**
                let totalAmount;
                try {
                    console.log('🧮 Calculating total amount...');
                    
                    // Debug the calculateTotal function step by step
                    const busType = document.getElementById('busType').value;
                    console.log('🚌 Bus type for calculation:', busType);
                    
                    if (!busType) {
                        throw new Error('Bus type is required for total calculation');
                    }
                    
                    // Check if required variables are defined
                    if (typeof seatPrices === 'undefined') {
                        throw new Error('seatPrices is not defined');
                    }
                    if (typeof serviceFee === 'undefined') {
                        throw new Error('serviceFee is not defined');
                    }
                    if (typeof taxRate === 'undefined') {
                        throw new Error('taxRate is not defined');
                    }
                    
                    console.log('✅ Required variables defined:', { seatPrices, serviceFee, taxRate });
                    
                    // Check selectedSeats
                    if (!selectedSeats || !Array.isArray(selectedSeats)) {
                        console.warn('⚠️ selectedSeats not properly defined, using default');
                        selectedSeats = ['A1']; // Default seat
                    }
                    console.log('✅ Selected seats for calculation:', selectedSeats);
                    
                    totalAmount = calculateTotal();
                    console.log('✅ Total amount calculated:', totalAmount);
                    
                    if (typeof totalAmount === 'undefined' || totalAmount === null) {
                        throw new Error('calculateTotal() returned undefined or null');
                    }
                    
                    if (isNaN(totalAmount)) {
                        throw new Error('calculateTotal() returned NaN');
                    }
                    
                } catch (calcError) {
                    console.error('❌ Error calculating total amount:', calcError);
                    showNotification('Failed to calculate total amount: ' + calcError.message + '. Please try again.', 'error');
                    return;
                }
                
                // Prepare booking data for API
                const bookingData = {
                    from_city: document.getElementById('fromCity').value.trim(),
                    to_city: document.getElementById('toCity').value.trim(),
                    departure_date: document.getElementById('departureDate').value.trim(),
                    departure_time: document.getElementById('departureTime').value.trim(),
                    bus_company: document.getElementById('busCompany').value.trim(),
                    bus_type: document.getElementById('busType').value.trim(),
                    passenger_count: parseInt(document.getElementById('passengerCount').value),
                    selected_seats: selectedSeats,
                    passenger_details: {
                        fullName: document.getElementById('fullName').value.trim(),
                        email: document.getElementById('email').value.trim(),
                        phone: document.getElementById('phone').value.trim(),
                        nationality: document.getElementById('nationality').value.trim(),
                        idNumber: document.getElementById('idNumber').value.trim(),
                        ageGroup: document.getElementById('ageGroup').value.trim(),
                        specialRequirements: document.getElementById('specialRequirements').value.trim()
                    },
                    total_amount: totalAmount, // Use the already calculated value
                    payment_method: paymentMethod
                };
                
                console.log('📤 Booking data prepared:', bookingData);

                // **FIXED: Don't create booking in database yet - only store data for payment**
                console.log('💾 Storing booking data for payment (no database creation yet)');
                
                // Generate a temporary booking ID for reference
                const tempBookingId = 'TEMP-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                
                console.log('🎫 Generated temporary booking ID:', tempBookingId);
                console.log('💰 Using calculated total amount:', totalAmount);
                
                // Extract form data (same as bookingData above)
                const fromCity = document.getElementById('fromCity').value.trim();
                const toCity = document.getElementById('toCity').value.trim();
                const departureDate = document.getElementById('departureDate').value.trim();
                const departureTime = document.getElementById('departureTime').value.trim();
                const busCompany = document.getElementById('busCompany').value.trim();
                const busType = document.getElementById('busType').value.trim();
                const passengerCount = parseInt(document.getElementById('passengerCount').value);
                const specialRequirements = document.getElementById('specialRequirements').value.trim();
                
                // Extract passenger details
                const passengerDetails = {
                    fullName: document.getElementById('fullName').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    nationality: document.getElementById('nationality').value.trim(),
                    idNumber: document.getElementById('idNumber').value.trim(),
                    ageGroup: document.getElementById('ageGroup').value.trim(),
                    specialRequirements: specialRequirements
                };
                
                // Calculate fare breakdown for payment page
                const pricePerSeat = seatPrices[busType] || 350;
                const seatCount = selectedSeats.length || 1;
                const seatPrice = seatCount * pricePerSeat;
                const taxAmount = Math.round(seatPrice * taxRate);
                
                // Store complete booking data for payment page
                const paymentData = {
                    booking_id: tempBookingId, // Temporary ID, real one will be generated in payment
                    total_amount: totalAmount,
                    payment_method: paymentMethod,
                    // Fare breakdown
                    seat_price: seatPrice,
                    service_fee: serviceFee,
                    tax_amount: taxAmount,
                    price_per_seat: pricePerSeat,
                    // Include all booking details for payment page summary
                    from_city: fromCity,
                    to_city: toCity,
                    departure_date: departureDate,
                    departure_time: departureTime,
                    bus_company: busCompany,
                    bus_type: busType,
                    passenger_count: passengerCount,
                    selected_seats: selectedSeats,
                    passenger_details: passengerDetails,
                    special_requirements: specialRequirements
                };
                
                localStorage.setItem('swiftbus_payment_data', JSON.stringify(paymentData));
                console.log('💾 Payment data stored in localStorage:', paymentData);
                
                // Clear seat reservation since we're proceeding to payment
                clearSeatReservation();
                
                // Show success message before redirect
                showNotification('Booking prepared! Redirecting to payment...', 'success');
                
                // Redirect to payment page after a short delay
                setTimeout(() => {
                    console.log('🔄 Redirecting to payment page...');
                    window.location.href = `payment.html?method=${paymentMethod}&booking_id=${tempBookingId}`;
                }, 1000);
                    
            } catch (error) {
                console.error('❌ Error in createBookingInDatabase:', error);
                
                // Reset payment buttons
                const paymentButtons = document.querySelectorAll('.pay-now-btn');
                paymentButtons.forEach(btn => {
                    btn.disabled = false;
                    // Reset button text based on payment method
                    const method = btn.closest('.payment-option').getAttribute('data-method');
                    const methodNames = {
                        'telebirr': 'Pay with Telebirr',
                        'cbe': 'Pay with CBE',
                        'dashen': 'Pay with Dashen',
                        'card': 'Pay with Card'
                    };
                    btn.innerHTML = methodNames[method] || 'Pay Now';
                });
                
                showNotification('Failed to prepare booking: ' + error.message + '. Please try again.', 'error');
            }
        }

        function calculateTotal() {
            try {
                console.log('🧮 calculateTotal() called');
                
                // Check if required variables are defined
                if (typeof seatPrices === 'undefined') {
                    console.error('❌ seatPrices is undefined');
                    throw new Error('seatPrices is not defined');
                }
                if (typeof serviceFee === 'undefined') {
                    console.error('❌ serviceFee is undefined');
                    throw new Error('serviceFee is not defined');
                }
                if (typeof taxRate === 'undefined') {
                    console.error('❌ taxRate is undefined');
                    throw new Error('taxRate is not defined');
                }
                
                const busTypeElement = document.getElementById('busType');
                if (!busTypeElement) {
                    console.error('❌ busType element not found');
                    throw new Error('Bus type element not found');
                }
                
                const busType = busTypeElement.value;
                console.log('🚌 Bus type:', busType);
                
                if (!busType) {
                    console.error('❌ Bus type not selected');
                    throw new Error('Bus type is required');
                }
                
                const pricePerSeat = seatPrices[busType] || 350;
                console.log('💰 Price per seat:', pricePerSeat);
                
                // Ensure selectedSeats is always an array
                if (!selectedSeats || !Array.isArray(selectedSeats)) {
                    console.warn('⚠️ selectedSeats not properly defined, using default');
                    selectedSeats = ['A1']; // Default to one seat
                }
                console.log('🪑 Selected seats:', selectedSeats);
                
                const seatCount = selectedSeats.length || 1;
                console.log('🔢 Seat count:', seatCount);
                
                const baseFare = seatCount * pricePerSeat;
                console.log('💵 Base fare:', baseFare);
                
                const tax = baseFare * taxRate;
                console.log('🏛️ Tax:', tax);
                
                const total = Math.round(baseFare + serviceFee + tax);
                console.log('💳 Total calculated:', total);
                
                if (isNaN(total)) {
                    console.error('❌ Total calculation resulted in NaN');
                    throw new Error('Total calculation resulted in NaN');
                }
                
                return total;
                
            } catch (error) {
                console.error('❌ Error in calculateTotal():', error);
                console.error('❌ Error stack:', error.stack);
                throw error;
            }
        }

        function setupEventListeners() {
            // Next button
            document.getElementById('nextBtn').addEventListener('click', function() {
                console.log(`🔘 Next button clicked - Current step: ${currentStep}`);
                
                if (validateStep(currentStep)) {
                    console.log(`✅ Step ${currentStep} validation passed, moving to step ${currentStep + 1}`);
                    currentStep++;
                    showStep(currentStep);
                } else {
                    console.log(`❌ Step ${currentStep} validation failed, staying on current step`);
                }
            });
            
            // Previous button
            document.getElementById('prevBtn').addEventListener('click', function() {
                if (currentStep > 1) {
                    currentStep--;
                    showStep(currentStep);
                }
            });
            
            // Payment method selection
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', function() {
                    const method = this.getAttribute('data-method');
                    selectPaymentMethod(method);
                });
            });
            
            // Download ticket button
            document.getElementById('downloadTicket').addEventListener('click', function() {
                showNotification('Ticket download started! Check your downloads folder.', 'success');
                // In a real app, this would generate and download a PDF ticket
            });
            
            // Close modal when clicking outside
            document.getElementById('confirmationModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
            
            // Update summary when form fields change
            const summaryUpdateFields = ['busCompany', 'busType', 'fromCity', 'toCity', 'departureDate', 'departureTime', 'passengerCount', 'ageGroup'];
            summaryUpdateFields.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateSummary);
                }
            });
            
            // Terms agreement
            document.getElementById('termsAgreement').addEventListener('change', function() {
                hideError('terms');
            });
            
            // Passenger count change
            document.getElementById('passengerCount').addEventListener('change', function() {
                const count = parseInt(this.value);
                
                // Ensure selectedSeats is always an array
                if (!selectedSeats || !Array.isArray(selectedSeats)) {
                    selectedSeats = [];
                }
                
                if (selectedSeats.length > count) {
                    // Deselect extra seats
                    selectedSeats = selectedSeats.slice(0, count);
                    updateSelectedSeatsDisplay();
                    updateSeatMapDisplay();
                    // Update localStorage with new selection
                    saveSelectedSeatsToStorage();
                }
                updateNavigationButtons();
                updateSummary();
            });
        }

        function updateSeatMapDisplay() {
            // Update visual selection on seat map
            document.querySelectorAll('.seat').forEach(seat => {
                const seatNumber = parseInt(seat.getAttribute('data-seat'));
                if (selectedSeats.includes(seatNumber)) {
                    seat.classList.add('selected');
                } else {
                    seat.classList.remove('selected');
                }
            });
        }

        // Function to show confirmation after payment (to be called from payment page)
        function showConfirmation(bookingId, amount) {
            document.getElementById('bookingId').textContent = bookingId;
            document.getElementById('bookingAmount').textContent = `ETB ${amount}`;
            document.getElementById('confirmationModal').classList.add('active');
        }
    </script>

    <script src="js/api.js"></script>
    <script>
        // API Integration for this page
        document.addEventListener('DOMContentLoaded', async function() {
            // Require user authentication
            const user = await authManager.requireAuth();
            if (!user) return;

        });

        // Helper functions for this page
        function updateUIForUser(user) {
            if (user) {
                // Update UI for logged-in user
                const userElements = document.querySelectorAll('.user-name');
                userElements.forEach(el => el.textContent = user.name);
                
                const loginBtns = document.querySelectorAll('.login-btn');
                loginBtns.forEach(btn => btn.style.display = 'none');
                
                const userMenus = document.querySelectorAll('.user-menu');
                userMenus.forEach(menu => menu.style.display = 'block');
            }
        }

        // Placeholder functions - implement as needed
        function displayPopularRoutes(routes) {
            console.log('Popular routes:', routes);
            // Implement route display logic
        }

        function populateCityDropdowns(cities) {
            console.log('Cities:', cities);
            // Implement city dropdown population
        }

        function displayUserBookings(bookings) {
            console.log('User bookings:', bookings);
            // Implement booking display logic
        }

        function displayBookingStats(stats) {
            console.log('Booking stats:', stats);
            // Implement stats display logic
        }

        function displayAdminStats(stats) {
            console.log('Admin stats:', stats);
            // Implement admin stats display logic
        }

        function displayAllBookings(bookings) {
            console.log('All bookings:', bookings);
            // Implement all bookings display logic
        }

        function displayBuses(buses) {
            console.log('Buses:', buses);
            // Implement buses display logic
        }

        function displaySchedules(schedules) {
            console.log('Schedules:', schedules);
            // Implement schedules display logic
        }
    </script>
</body>
</html>