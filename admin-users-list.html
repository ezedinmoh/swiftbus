<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Management - SwiftBus</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a73e8;
            --secondary: #ff6d00;
            --dark: #222;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        body {
            background: #f5f5f5;
            color: var(--dark);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 25px 20px;
            background: linear-gradient(135deg, var(--primary), #0d47a1);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .admin-details h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .admin-role {
            font-size: 12px;
            opacity: 0.9;
            background: rgba(255, 255, 255, 0.2);
            padding: 3px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-section {
            margin-bottom: 25px;
        }

        .menu-section h4 {
            padding: 0 20px 10px;
            color: var(--gray);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #eee;
        }

        .menu-items {
            list-style: none;
        }

        .menu-items li {
            margin: 5px 0;
        }

        .menu-items a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .menu-items a:hover {
            background: #f8f9fa;
            border-left-color: var(--primary);
            padding-left: 25px;
        }

        .menu-items a.active {
            background: #e8f0fe;
            border-left-color: var(--primary);
            color: var(--primary);
        }

        .menu-items a i {
            width: 20px;
            text-align: center;
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: all 0.3s ease;
        }

        /* Header */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .page-title h1 {
            font-size: 28px;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .page-title p {
            color: var(--gray);
            font-size: 14px;
        }

        .mobile-menu-toggle {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--dark);
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-right: 15px;
        }

        .mobile-menu-toggle:hover {
            background: #f8f9fa;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--dark);
            cursor: pointer;
            padding: 5px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0d47a1;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin: 0 auto 15px;
        }

        .stat-card.primary .stat-icon { background: var(--primary); }
        .stat-card.success .stat-icon { background: var(--success); }
        .stat-card.warning .stat-icon { background: var(--warning); }
        .stat-card.danger .stat-icon { background: var(--danger); }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray);
        }

        /* Filters and Search */
        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .filter-input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        /* Users Table */
        .users-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .users-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .users-table td {
            font-size: 14px;
            vertical-align: middle;
        }

        .users-table tbody tr {
            transition: all 0.3s ease;
        }

        .users-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* User Info Display */
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
        }

        .user-details h4 {
            font-size: 16px;
            margin-bottom: 4px;
            color: var(--dark);
        }

        .user-details p {
            font-size: 12px;
            color: var(--gray);
        }

        /* Contact Info Display */
        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .contact-email {
            font-weight: 500;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .contact-phone {
            font-size: 12px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .status-active {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }

        .status-suspended {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }

        .status-verified {
            background: rgba(26, 115, 232, 0.1);
            color: var(--primary);
        }

        .status-unverified {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
        }

        /* Bookings Info */
        .bookings-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .bookings-count {
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .trips-taken {
            font-size: 12px;
            color: var(--gray);
        }

        /* Actions */
        .actions-cell {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .action-btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        /* Loading and Empty States */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: var(--dark);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .form-text {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Mobile Responsive */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .content-header {
                padding: 15px;
            }
            
            .mobile-menu-btn {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: inline-block !important;
            }
            
            .page-title {
                display: flex;
                align-items: center;
            }
            
            .content-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
                margin-bottom: 10px;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            /* Fix page content responsiveness */
            .main-content {
                padding: 10px;
                width: 100%;
                min-width: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stat-card {
                padding: 15px;
                min-width: 0;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .users-container {
                margin: 10px 0;
                overflow-x: auto;
            }
            
            .table-header {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            /* Make table responsive */
            .users-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                min-width: 600px;
            }
            
            .users-table th,
            .users-table td {
                padding: 8px;
                font-size: 12px;
            }
            
            /* Fix form responsiveness */
            .form-control {
                padding: 10px;
                font-size: 14px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            /* Fix user info display on mobile */
            .user-info {
                flex-direction: column;
                text-align: center;
                gap: 5px;
            }
            
            .contact-info {
                text-align: center;
            }
            
            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
                max-height: calc(100vh - 20px);
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions .btn {
                margin-bottom: 10px;
            }
            
            .filters-section {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 5px;
            }
            
            .stat-card {
                padding: 10px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .users-container {
                margin: 5px 0;
            }
            
            .form-control {
                padding: 8px;
                font-size: 14px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .user-info {
                flex-direction: column;
                text-align: center;
                gap: 3px;
            }
            
            .content-header {
                padding: 10px;
            }
            
            .table-header {
                padding: 10px;
            }
            
            .filters-section {
                padding: 10px;
            }
            
            .modal-content {
                margin: 5px;
                width: calc(100% - 10px);
                max-height: calc(100vh - 10px);
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="admin-info">
                <div class="admin-avatar">
                    <i class="fas fa-user-cog"></i>
                </div>
                <div class="admin-details">
                    <h3 id="sidebarAdminName">Admin User</h3>
                    <span class="admin-role">Administrator</span>
                </div>
            </div>
        </div>
        
        <div class="sidebar-menu">
            <div class="menu-section">
                <h4>Dashboard</h4>
                <ul class="menu-items">
                    <li><a href="admin-dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a></li>
                </ul>
            </div>
            
            <div class="menu-section">
                <h4>Management</h4>
                <ul class="menu-items">
                    <li><a href="admin-buses-list.html">
                        <i class="fas fa-bus"></i>
                        Buses
                    </a></li>
                    <li><a href="admin-routes-list.html">
                        <i class="fas fa-route"></i>
                        Routes
                    </a></li>
                    <li><a href="admin-schedules-list.html">
                        <i class="fas fa-calendar-alt"></i>
                        Schedules
                    </a></li>
                    <li><a href="admin-bookings-all.html">
                        <i class="fas fa-ticket-alt"></i>
                        Bookings
                    </a></li>
                    <li><a href="admin-users-list.html" class="active">
                        <i class="fas fa-users"></i>
                        Users
                    </a></li>
                </ul>
            </div>
            
            <div class="menu-section">
                <h4>Account</h4>
                <ul class="menu-items">
                    <li><a href="admin-profile.html">
                        <i class="fas fa-user-circle"></i>
                        Profile
                    </a></li>
                    <li><a href="#" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="content-header">
            <div>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <div class="page-title">
                <h1>Users Management</h1>
                <p>View and manage all system users</p>
            </div>
            
            <div class="header-actions">
                <button class="btn btn-success" id="exportBtn">
                    <i class="fas fa-download"></i>
                    Export Users
                </button>
                <button class="btn btn-primary" id="addUserBtn">
                    <i class="fas fa-plus"></i>
                    Add User
                </button>
                <button class="btn btn-primary" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            
            <div class="stat-card success">
                <div class="stat-icon">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="stat-value" id="activeUsers">0</div>
                <div class="stat-label">Active Users</div>
            </div>
            
            <div class="stat-card warning">
                <div class="stat-icon">
                    <i class="fas fa-user-clock"></i>
                </div>
                <div class="stat-value" id="unverifiedUsers">0</div>
                <div class="stat-label">Unverified Users</div>
            </div>
            
            <div class="stat-card danger">
                <div class="stat-icon">
                    <i class="fas fa-user-slash"></i>
                </div>
                <div class="stat-value" id="suspendedUsers">0</div>
                <div class="stat-label">Suspended Users</div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Search Users</label>
                    <input type="text" class="filter-input" id="searchInput" placeholder="Search by name, email, or phone...">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Account Status</label>
                    <select class="filter-input" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="suspended">Suspended</option>
                        <option value="verified">Verified</option>
                        <option value="unverified">Unverified</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Registration Date</label>
                    <input type="date" class="filter-input" id="dateFilter">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Min Bookings</label>
                    <input type="number" class="filter-input" id="bookingsFilter" placeholder="0" min="0">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">&nbsp;</label>
                    <button class="btn btn-secondary" id="clearFiltersBtn">
                        <i class="fas fa-times"></i>
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="users-container">
            <div class="table-header">
                <div class="table-title">
                    <i class="fas fa-users"></i>
                    System Users
                </div>
                <div>
                    <span id="usersCount">0 users</span>
                </div>
            </div>
            
            <div id="usersTableContainer">
                <!-- Loading state -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner"></div>
                    <h3>Loading Users...</h3>
                    <p>Please wait while we fetch the user data.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle"><i class="fas fa-user-plus"></i> Add New User</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-control" id="userFullName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="userPhone" placeholder="+251 9XX XXX XXX">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Account Status</label>
                        <select class="form-control" id="userStatus">
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="verified">Verified</option>
                            <option value="unverified">Unverified</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="passwordGroup">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="userPassword" required>
                        <small class="form-text text-muted">Minimum 8 characters</small>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary" id="saveUserBtn">
                            <i class="fas fa-save"></i>
                            Save User
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelUserBtn">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/admin-profile-sync.js"></script>
    <script src="js/admin-modals.js"></script>
    <script>
        let swiftBusAPI;
        let currentUsers = [];
        let filteredUsers = [];

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ Initializing admin users page...');
                
                // Wait for API to be available
                let attempts = 0;
                while (typeof SwiftBusAPI === 'undefined' && attempts < 10) {
                    console.log(`‚è≥ Waiting for SwiftBusAPI... (attempt ${attempts + 1})`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (typeof SwiftBusAPI !== 'undefined') {
                    swiftBusAPI = new SwiftBusAPI();
                    console.log('‚úÖ SwiftBusAPI initialized for users management');
                } else {
                    throw new Error('SwiftBusAPI not available after waiting');
                }

                // Setup event listeners first
                setupEventListeners();
                
                // Check authentication and load data
                await checkAuthenticationAndLoadData();
                
            } catch (error) {
                console.error('üí• Failed to initialize users page:', error);
                console.error('Error details:', error);
                showErrorMessage(`Failed to initialize page: ${error.message}. Please refresh.`);
            }
        });

        async function checkAuthenticationAndLoadData() {
            try {
                console.log('üîê Checking admin authentication...');
                
                // Ensure DOM elements exist before proceeding
                if (!document.getElementById('loadingState')) {
                    console.error('‚ùå Required DOM elements not found');
                    throw new Error('Page not properly loaded');
                }
                
                const response = await swiftBusAPI.checkSession();
                console.log('üì° Auth response:', response);
                
                if (!response.success || !response.data) {
                    console.log('‚ùå User not authenticated, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                const userData = response.data;
                console.log('‚úÖ User authenticated:', userData);
                
                if (userData.role !== 'admin') {
                    console.log('‚ùå Access denied - User role:', userData.role);
                    showAdminAlert(`Access denied. Admin privileges required.<br><br>Your role: <strong>${userData.role}</strong>`, 'error', 'Access Denied');
                    setTimeout(() => { window.location.href = 'index.html'; }, 2000);
                    return;
                }
                
                // Update sidebar with user info
                const sidebarNameElement = document.getElementById('sidebarAdminName');
                if (sidebarNameElement) {
                    sidebarNameElement.textContent = userData.name || userData.full_name || 'Admin User';
                }
                
                // Load users data
                await loadUsersData();
                
                console.log('‚úÖ Users page loaded successfully');
                
            } catch (error) {
                console.error('üí• Authentication check failed:', error);
                console.error('Error stack:', error.stack);
                
                // More user-friendly error handling
                if (error.message && error.message.includes('fetch')) {
                    showErrorMessage('Cannot connect to server. Please check your connection and try again.');
                } else if (error.message && error.message.includes('API')) {
                    showErrorMessage('Server API error. Please contact support if this persists.');
                } else {
                    showErrorMessage(`Authentication failed: ${error.message}. Please try refreshing the page or logging in again.`);
                }
                
                // Don't redirect immediately, let user see the error
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
            }
        }

        async function loadUsersData() {
            try {
                console.log('üìä Loading real users data from database...');
                showLoadingState();
                
                // First, load user statistics
                try {
                    const statsResponse = await swiftBusAPI.request('admin_users.php?action=get_user_stats');
                    console.log('üìà User stats response:', statsResponse);
                    
                    if (statsResponse.success && statsResponse.data) {
                        // Update statistics cards with real data
                        document.getElementById('totalUsers').textContent = statsResponse.data.total_users || 0;
                        document.getElementById('activeUsers').textContent = statsResponse.data.active_users || 0;
                        document.getElementById('unverifiedUsers').textContent = statsResponse.data.unverified_users || 0;
                        document.getElementById('suspendedUsers').textContent = statsResponse.data.suspended_users || 0;
                    }
                } catch (statsError) {
                    console.warn('‚ö†Ô∏è Failed to load user stats:', statsError);
                }
                
                // Get real users data from API - NO FALLBACK TO SAMPLE DATA
                let usersResponse;
                try {
                    const searchTerm = document.getElementById('searchInput').value || '';
                    const roleFilter = document.getElementById('roleFilter')?.value || '';
                    const statusFilter = document.getElementById('statusFilter').value || '';
                    
                    let apiUrl = 'admin_users.php?action=get_users';
                    if (searchTerm) apiUrl += `&search=${encodeURIComponent(searchTerm)}`;
                    if (roleFilter) apiUrl += `&role=${encodeURIComponent(roleFilter)}`;
                    if (statusFilter) apiUrl += `&status=${encodeURIComponent(statusFilter)}`;
                    
                    usersResponse = await swiftBusAPI.request(apiUrl);
                    console.log('üìà Users API response:', usersResponse);
                } catch (apiError) {
                    console.error('‚ùå Users API failed:', apiError);
                    hideLoadingState();
                    showErrorMessage('Failed to connect to database. Please check your server connection.');
                    currentUsers = [];
                    filteredUsers = [];
                    displayUsers([]);
                    return;
                }
                
                if (usersResponse.success && usersResponse.data) {
                    // Map database fields to display fields
                    currentUsers = usersResponse.data.map(user => ({
                        id: user.user_id || user.id,
                        user_id: user.user_id || user.id,
                        email: user.email || '',
                        first_name: user.first_name || '',
                        last_name: user.last_name || '',
                        full_name: user.full_name || `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Unknown User',
                        phone: user.phone || 'N/A',
                        role: user.role || 'user',
                        is_active: user.is_active,
                        is_verified: user.is_verified,
                        status: user.status || (user.is_active ? 'active' : 'suspended'),
                        joined_date: user.joined_date || user.created_at,
                        registration_date: user.joined_date || user.created_at,
                        last_login: user.last_login || 'Never',
                        login_attempts: user.login_attempts || 0,
                        profile_image: user.profile_image || null,
                        created_at: user.created_at,
                        total_bookings: parseInt(user.total_bookings) || 0,
                        trips_taken: Math.floor((parseInt(user.total_bookings) || 0) * 0.8),
                        total_spent: parseFloat(user.total_spent) || 0,
                        status_label: user.status_label || (user.is_active ? 'Active' : 'Inactive'),
                        verification_label: user.verification_label || (user.is_verified ? 'Verified' : 'Unverified')
                    }));
                    console.log(`‚úÖ Loaded ${currentUsers.length} users from database`);
                } else {
                    // No data or API error - show empty state, NOT sample data
                    console.log('üì≠ No users found in database or API error');
                    currentUsers = [];
                }
                
                // Update statistics from loaded data (as backup)
                updateStatistics();
                
                // Display users
                filteredUsers = [...currentUsers];
                displayUsers(filteredUsers);
                
                hideLoadingState();
                console.log('‚úÖ Users data loaded successfully');
                
            } catch (error) {
                console.error('üí• Failed to load users data:', error);
                hideLoadingState();
                showErrorMessage('Failed to load users data: ' + error.message);
                currentUsers = [];
                filteredUsers = [];
                displayUsers([]);
                updateStatistics();
            }
        }
        
        function loadFallbackUsersData() {
            console.log('üì¶ Loading users data from localStorage...');
            
            // Try to get user data from localStorage
            const storedBookings = JSON.parse(localStorage.getItem('swiftbus_bookings') || '[]');
            const storedUserData = JSON.parse(localStorage.getItem('swiftbus_user_data') || '{}');
            
            const fallbackUsers = [];
            
            // Create users from booking data
            const userEmails = new Set();
            storedBookings.forEach((booking, index) => {
                const email = booking.passenger_email || booking.user_email || `user${index + 1}@example.com`;
                
                if (!userEmails.has(email)) {
                    userEmails.add(email);
                    
                    const userName = booking.passenger_name || booking.user_name || `User ${index + 1}`;
                    const nameParts = userName.split(' ');
                    
                    fallbackUsers.push({
                        id: `USR${String(index + 1).padStart(3, '0')}`,
                        user_id: `U${Date.now()}${index}`,
                        email: email,
                        first_name: nameParts[0] || 'User',
                        last_name: nameParts.slice(1).join(' ') || `${index + 1}`,
                        full_name: userName,
                        phone: booking.passenger_phone || booking.user_phone || `+251911${String(index).padStart(6, '0')}`,
                        role: 'user',
                        is_active: 1,
                        is_verified: Math.random() > 0.3 ? 1 : 0,
                        status: Math.random() > 0.8 ? 'suspended' : 'active',
                        joined_date: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        registration_date: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        last_login: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
                        created_at: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString(),
                        total_bookings: storedBookings.filter(b => 
                            (b.passenger_email || b.user_email) === email
                        ).length,
                        trips_taken: Math.floor(storedBookings.filter(b => 
                            (b.passenger_email || b.user_email) === email
                        ).length * 0.8),
                        total_spent: storedBookings
                            .filter(b => (b.passenger_email || b.user_email) === email)
                            .reduce((sum, b) => sum + (parseFloat(b.total_amount) || parseFloat(b.amount) || 0), 0),
                        status_label: 'Active',
                        verification_label: Math.random() > 0.3 ? 'Verified' : 'Unverified'
                    });
                }
            });
            
            // Add current logged-in user if available
            if (storedUserData.email && !userEmails.has(storedUserData.email)) {
                fallbackUsers.unshift({
                    id: 'USR000',
                    user_id: storedUserData.id || 'U' + Date.now(),
                    email: storedUserData.email,
                    first_name: storedUserData.firstName || storedUserData.first_name || 'Current',
                    last_name: storedUserData.lastName || storedUserData.last_name || 'User',
                    full_name: storedUserData.name || storedUserData.full_name || 'Current User',
                    phone: storedUserData.phone || '+251911000000',
                    role: storedUserData.role || 'user',
                    is_active: 1,
                    is_verified: 1,
                    status: 'active',
                    joined_date: storedUserData.joinedDate || new Date().toISOString().split('T')[0],
                    registration_date: storedUserData.joinedDate || new Date().toISOString().split('T')[0],
                    last_login: new Date().toISOString(),
                    created_at: storedUserData.joinedDate || new Date().toISOString(),
                    total_bookings: storedBookings.length,
                    trips_taken: Math.floor(storedBookings.length * 0.8),
                    total_spent: storedBookings.reduce((sum, b) => sum + (parseFloat(b.total_amount) || parseFloat(b.amount) || 0), 0),
                    status_label: 'Active',
                    verification_label: 'Verified'
                });
            }
            
            // If no data from localStorage, create some default users
            if (fallbackUsers.length === 0) {
                const defaultUsers = [
                    { name: 'John Doe', email: 'john@example.com' },
                    { name: 'Jane Smith', email: 'jane@example.com' },
                    { name: 'Mike Johnson', email: 'mike@example.com' },
                    { name: 'Sarah Williams', email: 'sarah@example.com' },
                    { name: 'Robert Brown', email: 'robert@example.com' }
                ];
                
                defaultUsers.forEach((user, index) => {
                    const nameParts = user.name.split(' ');
                    fallbackUsers.push({
                        id: `USR${String(index + 1).padStart(3, '0')}`,
                        user_id: `U${Date.now()}${index}`,
                        email: user.email,
                        first_name: nameParts[0],
                        last_name: nameParts[1] || '',
                        full_name: user.name,
                        phone: `+251911${String(index + 1).padStart(6, '0')}`,
                        role: 'user',
                        is_active: 1,
                        is_verified: Math.random() > 0.3 ? 1 : 0,
                        status: Math.random() > 0.8 ? 'suspended' : 'active',
                        joined_date: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        registration_date: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        last_login: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
                        created_at: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString(),
                        total_bookings: Math.floor(Math.random() * 10),
                        trips_taken: Math.floor(Math.random() * 8),
                        total_spent: Math.floor(Math.random() * 5000),
                        status_label: 'Active',
                        verification_label: Math.random() > 0.3 ? 'Verified' : 'Unverified'
                    });
                });
            }
            
            console.log(`‚úÖ Created ${fallbackUsers.length} fallback users from localStorage data`);
            return fallbackUsers;
        }

        function generateSampleUsers() {
            const sampleNames = [
                'Abebe Kebede', 'Almaz Tadesse', 'Dawit Haile', 'Hanan Mohammed', 
                'Kidist Wolde', 'Meron Assefa', 'Robel Tesfaye', 'Sara Ahmed',
                'Tekle Girma', 'Yodit Bekele', 'Zelalem Desta', 'Bethlehem Negash',
                'Mulugeta Worku', 'Tigist Alemu', 'Getachew Mengistu', 'Selamawit Teshome',
                'Berhanu Fekadu', 'Meseret Tadele', 'Addisu Bekele', 'Rahel Tesfaye'
            ];
            
            const statuses = ['active', 'suspended', 'verified', 'unverified'];
            const users = [];
            
            sampleNames.forEach((name, index) => {
                const userId = `USR${(index + 1).toString().padStart(3, '0')}`;
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const email = name.toLowerCase().replace(' ', '.') + '@email.com';
                const phone = `+251 9${Math.floor(Math.random() * 90000000) + 10000000}`;
                
                // Generate booking statistics
                const totalBookings = Math.floor(Math.random() * 20); // 0-19 bookings
                const tripsTaken = Math.floor(totalBookings * 0.8); // 80% completion rate
                
                // Generate registration date (last 2 years)
                const registrationDate = new Date();
                registrationDate.setDate(registrationDate.getDate() - Math.floor(Math.random() * 730));
                
                users.push({
                    id: userId,
                    full_name: name,
                    email: email,
                    phone: phone,
                    status: status,
                    total_bookings: totalBookings,
                    trips_taken: tripsTaken,
                    registration_date: registrationDate.toISOString().split('T')[0],
                    last_login: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    email_verified: status === 'verified' || Math.random() > 0.3,
                    created_at: registrationDate.toISOString()
                });
            });
            
            // Sort by registration date (newest first)
            users.sort((a, b) => new Date(b.registration_date) - new Date(a.registration_date));
            
            return users;
        }

        function updateStatistics() {
            const totalUsers = currentUsers.length;
            const activeUsers = currentUsers.filter(user => user.is_active || user.status === 'active').length;
            const verifiedUsers = currentUsers.filter(user => user.is_verified || user.email_verified || user.status === 'verified').length;
            const suspendedUsers = currentUsers.filter(user => user.status === 'suspended' || (!user.is_active && user.is_active !== undefined)).length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            
            // Handle different element IDs that might exist
            const unverifiedElement = document.getElementById('unverifiedUsers') || document.getElementById('verifiedUsers');
            if (unverifiedElement) {
                if (unverifiedElement.id === 'verifiedUsers') {
                    unverifiedElement.textContent = verifiedUsers;
                } else {
                    unverifiedElement.textContent = totalUsers - verifiedUsers;
                }
            }
            
            const suspendedElement = document.getElementById('suspendedUsers') || document.getElementById('adminUsers');
            if (suspendedElement) {
                if (suspendedElement.id === 'adminUsers') {
                    const adminUsers = currentUsers.filter(user => user.role === 'admin').length;
                    suspendedElement.textContent = adminUsers;
                } else {
                    suspendedElement.textContent = suspendedUsers;
                }
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('usersTableContainer');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No Users Found</h3>
                        <p>There are no users in the database yet, or no users match your current filters.</p>
                        <p style="font-size: 12px; color: #888; margin-top: 10px;">Users will appear here when they register on the platform.</p>
                    </div>
                `;
                document.getElementById('usersCount').textContent = '0 users';
                return;
            }
            
            const tableHTML = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Full Name üë§</th>
                            <th>Email & Phone üìßüì±</th>
                            <th>Account Status ‚úÖ</th>
                            <th>Total Bookings / Trips Taken üßæ</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map((user, index) => {
                            // Ensure we have a consistent ID
                            const userId = user.id || user.user_id || `user_${index}`;
                            const initials = user.full_name.split(' ').map(n => n[0]).join('');
                            const registrationDate = user.registration_date || user.joined_date || user.created_at || new Date().toISOString().split('T')[0];
                            const userStatus = user.status || (user.is_active ? 'active' : 'suspended');
                            const totalBookings = user.total_bookings || 0;
                            const tripsTaken = user.trips_taken || Math.floor(totalBookings * 0.8);
                            
                            return `
                                <tr>
                                    <td>
                                        <strong>${userId}</strong>
                                    </td>
                                    <td>
                                        <div class="user-info">
                                            <div class="user-avatar">
                                                ${initials}
                                            </div>
                                            <div class="user-details">
                                                <h4>${user.full_name}</h4>
                                                <p>Joined: ${new Date(registrationDate).toLocaleDateString()}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="contact-info">
                                            <div class="contact-email">
                                                <i class="fas fa-envelope"></i>
                                                ${user.email}
                                            </div>
                                            <div class="contact-phone">
                                                <i class="fas fa-phone"></i>
                                                ${user.phone}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="status-badge status-${userStatus}">
                                            <i class="fas fa-${getStatusIcon(userStatus)}"></i>
                                            ${userStatus}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="bookings-info">
                                            <div class="bookings-count">
                                                <i class="fas fa-ticket-alt"></i>
                                                ${totalBookings} bookings
                                            </div>
                                            <div class="trips-taken">${tripsTaken} trips completed</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="actions-cell">
                                            <button class="action-btn btn-primary" onclick="viewUserDetails('${userId}')" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="action-btn btn-danger" onclick="suspendUser('${userId}')" title="Suspend User">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            document.getElementById('usersCount').textContent = `${users.length} user${users.length !== 1 ? 's' : ''}`;
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'active': return 'check-circle';
                case 'suspended': return 'ban';
                case 'verified': return 'user-check';
                case 'unverified': return 'user-clock';
                default: return 'user';
            }
        }

        function setupEventListeners() {
            // Search and filter functionality
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
            document.getElementById('bookingsFilter').addEventListener('input', applyFilters);
            
            // Clear filters
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadUsersData();
            });
            
            // Export button
            document.getElementById('exportBtn').addEventListener('click', () => {
                exportUsers();
            });
            
            // Add user button
            document.getElementById('addUserBtn').addEventListener('click', () => {
                openUserModal();
            });
            
            // Modal event listeners
            document.getElementById('closeModal').addEventListener('click', closeUserModal);
            document.getElementById('cancelUserBtn').addEventListener('click', closeUserModal);
            document.getElementById('userForm').addEventListener('submit', saveUser);
            
            // Close modal when clicking outside
            document.getElementById('userModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUserModal();
                }
            });
            
            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await swiftBusAPI.logout();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout failed:', error);
                    // Force logout anyway
                    window.location.href = 'login.html';
                }
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const bookingsFilter = parseInt(document.getElementById('bookingsFilter').value) || 0;
            
            filteredUsers = currentUsers.filter(user => {
                const matchesSearch = !searchTerm || 
                    user.full_name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    user.phone.toLowerCase().includes(searchTerm) ||
                    user.id.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || user.status === statusFilter;
                const matchesDate = !dateFilter || user.registration_date === dateFilter;
                const matchesBookings = user.total_bookings >= bookingsFilter;
                
                return matchesSearch && matchesStatus && matchesDate && matchesBookings;
            });
            
            displayUsers(filteredUsers);
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('bookingsFilter').value = '';
            
            filteredUsers = [...currentUsers];
            displayUsers(filteredUsers);
        }

        function viewUserDetails(userId) {
            console.log('Viewing user details for:', userId);
            
            // Try multiple ways to find the user
            let user = currentUsers.find(u => u.id === userId);
            if (!user) {
                user = currentUsers.find(u => u.user_id === userId);
            }
            if (!user) {
                user = currentUsers.find(u => String(u.id) === String(userId));
            }
            if (!user) {
                user = currentUsers.find(u => String(u.user_id) === String(userId));
            }
            
            if (user) {
                console.log('User found:', user);
                openUserModal(user, 'view');
            } else {
                console.error('User not found:', userId);
                console.log('Available users:', currentUsers.map(u => ({ id: u.id, user_id: u.user_id, name: u.full_name })));
                showNotification('User not found. Please refresh the page and try again.', 'error');
            }
        }

        function editUser(userId) {
            const user = currentUsers.find(u => u.id === userId);
            if (user) {
                openUserModal(user, 'edit');
            }
        }

        function suspendUser(userId) {
            // Find user with robust ID matching
            let user = currentUsers.find(u => u.id === userId);
            if (!user) {
                user = currentUsers.find(u => u.user_id === userId);
            }
            if (!user) {
                user = currentUsers.find(u => String(u.id) === String(userId));
            }
            if (!user) {
                user = currentUsers.find(u => String(u.user_id) === String(userId));
            }
            
            if (!user) {
                showNotification('User not found. Please refresh the page and try again.', 'error');
                return;
            }
            
            if (confirm(`Are you sure you want to suspend user ${user.full_name} (${userId})?`)) {
                const reason = prompt('Enter suspension reason:') || 'Suspended by admin';
                
                // Call API to suspend user
                swiftBusAPI.request('admin_users.php?action=suspend_user', {
                    method: 'POST',
                    body: JSON.stringify({ user_id: userId, reason: reason })
                }).then(response => {
                    if (response.success) {
                        // Update local data
                        const userIndex = currentUsers.findIndex(u => 
                            u.id === userId || u.user_id === userId || 
                            String(u.id) === String(userId) || String(u.user_id) === String(userId)
                        );
                        
                        if (userIndex !== -1) {
                            currentUsers[userIndex].status = 'suspended';
                            currentUsers[userIndex].is_active = 0;
                            currentUsers[userIndex].suspension_reason = reason;
                        }
                        
                        // Refresh display
                        updateStatistics();
                        filteredUsers = [...currentUsers];
                        displayUsers(filteredUsers);
                        
                        showNotification(`User ${user.full_name} suspended successfully. Reason: ${reason}`, 'success');
                    } else {
                        showNotification('Failed to suspend user: ' + (response.message || 'Unknown error'), 'error');
                    }
                }).catch(error => {
                    console.error('Failed to suspend user:', error);
                    showNotification('Failed to suspend user. Please try again.', 'error');
                });
            }
        }

        // Modal functions
        function openUserModal(user = null, mode = 'add') {
            const modal = document.getElementById('userModal');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('userForm');
            const passwordGroup = document.getElementById('passwordGroup');
            const saveBtn = document.getElementById('saveUserBtn');
            
            // Reset form
            form.reset();
            
            if (mode === 'add') {
                modalTitle.innerHTML = '<i class="fas fa-user-plus"></i> Add New User';
                passwordGroup.style.display = 'block';
                document.getElementById('userPassword').required = true;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Add User';
                saveBtn.style.display = 'inline-flex';
                
                // Enable all form fields
                const formElements = form.querySelectorAll('input, select');
                formElements.forEach(element => {
                    element.disabled = false;
                });
                
            } else if (mode === 'edit') {
                modalTitle.innerHTML = '<i class="fas fa-user-edit"></i> Edit User';
                passwordGroup.style.display = 'none';
                document.getElementById('userPassword').required = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Update User';
                saveBtn.style.display = 'inline-flex';
                
                // Enable all form fields
                const formElements = form.querySelectorAll('input, select');
                formElements.forEach(element => {
                    element.disabled = false;
                });
                
                // Populate form with user data
                document.getElementById('userFullName').value = user.full_name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userPhone').value = user.phone;
                document.getElementById('userStatus').value = user.status;
                
            } else if (mode === 'view') {
                modalTitle.innerHTML = '<i class="fas fa-user"></i> User Details';
                passwordGroup.style.display = 'none';
                saveBtn.style.display = 'none';
                
                // Populate and disable form fields
                document.getElementById('userFullName').value = user.full_name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userPhone').value = user.phone;
                document.getElementById('userStatus').value = user.status;
                
                // Disable all form fields
                const formElements = form.querySelectorAll('input, select');
                formElements.forEach(element => {
                    element.disabled = true;
                });
                
                // Add additional user details below the form
                const modalBody = modal.querySelector('.modal-body');
                let detailsSection = modalBody.querySelector('.user-details-section');
                
                if (!detailsSection) {
                    detailsSection = document.createElement('div');
                    detailsSection.className = 'user-details-section';
                    modalBody.appendChild(detailsSection);
                }
                
                detailsSection.innerHTML = `
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                        <h4 style="color: var(--primary); margin-bottom: 20px;"><i class="fas fa-info-circle"></i> Additional Information</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <h5 style="color: var(--dark); margin-bottom: 10px;">Account Information</h5>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <p><strong>User ID:</strong> ${user.user_id || user.id}</p>
                                    <p><strong>Role:</strong> <span class="status-badge status-${user.role}">${user.role?.charAt(0).toUpperCase() + user.role?.slice(1) || 'User'}</span></p>
                                    <p><strong>Email Verified:</strong> ${user.is_verified ? '‚úÖ Yes' : '‚ùå No'}</p>
                                    <p><strong>Account Active:</strong> ${user.is_active ? '‚úÖ Yes' : '‚ùå No'}</p>
                                    <p><strong>Login Attempts:</strong> ${user.login_attempts || 0}</p>
                                </div>
                            </div>
                            <div>
                                <h5 style="color: var(--dark); margin-bottom: 10px;">Activity Information</h5>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <p><strong>Joined Date:</strong> ${user.joined_date ? new Date(user.joined_date).toLocaleDateString() : 'N/A'}</p>
                                    <p><strong>Last Login:</strong> ${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</p>
                                    <p><strong>Total Bookings:</strong> ${user.total_bookings || 0}</p>
                                    <p><strong>Total Spent:</strong> ${user.total_spent ? 'ETB ' + user.total_spent : 'ETB 0.00'}</p>
                                </div>
                            </div>
                        </div>
                        
                        ${user.profile_image ? `
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: var(--dark); margin-bottom: 10px;">Profile Image</h5>
                                <div style="text-align: center;">
                                    <img src="${user.profile_image}" alt="Profile" style="max-width: 150px; max-height: 150px; border-radius: 50%; border: 3px solid var(--primary);">
                                </div>
                            </div>
                        ` : ''}
                        
                        ${user.suspension_reason ? `
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: var(--danger); margin-bottom: 10px;">Suspension Information</h5>
                                <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid var(--danger);">
                                    <p><strong>Reason:</strong> ${user.suspension_reason}</p>
                                    <p><strong>Status:</strong> <span class="status-badge status-suspended">Suspended</span></p>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: var(--dark); margin-bottom: 10px;">Quick Actions</h5>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                ${user.status !== 'suspended' ? `
                                    <button class="btn btn-danger" onclick="closeUserModal(); suspendUser('${user.id}');">
                                        <i class="fas fa-ban"></i> Suspend User
                                    </button>
                                ` : `
                                    <button class="btn btn-success" onclick="closeUserModal(); reactivateUser('${user.id}');">
                                        <i class="fas fa-check"></i> Reactivate User
                                    </button>
                                `}
                                <button class="btn btn-primary" onclick="viewUserBookings('${user.id}');">
                                    <i class="fas fa-ticket-alt"></i> View Bookings
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Remove details section for add/edit modes
                const modalBody = modal.querySelector('.modal-body');
                const detailsSection = modalBody.querySelector('.user-details-section');
                if (detailsSection) {
                    detailsSection.remove();
                }
            }
            
            // Store current mode and user
            modal.dataset.mode = mode;
            modal.dataset.userId = user ? user.id : '';
            
            modal.classList.add('active');
        }

        function closeUserModal() {
            const modal = document.getElementById('userModal');
            const form = document.getElementById('userForm');
            const saveBtn = document.getElementById('saveUserBtn');
            
            modal.classList.remove('active');
            form.reset();
            saveBtn.style.display = 'inline-flex';
            
            // Re-enable all form fields
            const formElements = form.querySelectorAll('input, select');
            formElements.forEach(element => {
                element.disabled = false;
            });
            
            // Remove details section
            const modalBody = modal.querySelector('.modal-body');
            const detailsSection = modalBody.querySelector('.user-details-section');
            if (detailsSection) {
                detailsSection.remove();
            }
        }

        function reactivateUser(userId) {
            if (confirm(`Are you sure you want to reactivate user ${userId}?`)) {
                // Call API to activate user
                swiftBusAPI.request('admin_users.php?action=activate_user', {
                    method: 'POST',
                    body: JSON.stringify({ user_id: userId })
                }).then(response => {
                    if (response.success) {
                        // Update local data
                        const userIndex = currentUsers.findIndex(u => 
                            u.id === userId || u.user_id === userId ||
                            String(u.id) === String(userId) || String(u.user_id) === String(userId)
                        );
                        
                        if (userIndex !== -1) {
                            currentUsers[userIndex].status = 'active';
                            currentUsers[userIndex].is_active = 1;
                            delete currentUsers[userIndex].suspension_reason;
                        }
                        
                        // Refresh display
                        updateStatistics();
                        filteredUsers = [...currentUsers];
                        displayUsers(filteredUsers);
                        
                        showNotification(`User ${userId} reactivated successfully!`, 'success');
                    } else {
                        showNotification('Failed to reactivate user: ' + (response.message || 'Unknown error'), 'error');
                    }
                }).catch(error => {
                    console.error('Failed to reactivate user:', error);
                    showNotification('Failed to reactivate user. Please try again.', 'error');
                });
            }
        }

        function viewUserBookings(userId) {
            // Create modal for user bookings
            let modal = document.getElementById('userBookingsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'userBookingsModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px;">
                        <div class="modal-header">
                            <h3 id="userBookingsModalTitle"><i class="fas fa-ticket-alt"></i> User Bookings</h3>
                            <button class="modal-close" onclick="closeUserBookingsModal()">&times;</button>
                        </div>
                        <div class="modal-body" id="userBookingsModalBody">
                            <!-- Bookings will be populated here -->
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Add click outside to close
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            }

            const user = currentUsers.find(u => u.id === userId);
            const modalTitle = document.getElementById('userBookingsModalTitle');
            const modalBody = document.getElementById('userBookingsModalBody');

            modalTitle.innerHTML = `<i class="fas fa-ticket-alt"></i> Bookings for ${user?.full_name || 'User'}`;

            // Generate sample bookings for demonstration
            const sampleBookings = [
                {
                    id: 'BK001',
                    route: 'Addis Ababa ‚Üí Bahirdar',
                    date: '2025-01-15',
                    status: 'confirmed',
                    amount: 450,
                    seats: 2
                },
                {
                    id: 'BK002', 
                    route: 'Bahirdar ‚Üí Addis Ababa',
                    date: '2025-01-20',
                    status: 'completed',
                    amount: 450,
                    seats: 2
                }
            ];

            if (sampleBookings.length === 0) {
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-ticket-alt" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                        <h3>No Bookings Found</h3>
                        <p>This user hasn't made any bookings yet.</p>
                    </div>
                `;
            } else {
                modalBody.innerHTML = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px;">
                        <h4 style="color: var(--success); margin: 0;">
                            <i class="fas fa-info-circle"></i> 
                            Total Bookings: ${sampleBookings.length} | Total Spent: ETB ${sampleBookings.reduce((sum, b) => sum + b.amount, 0)}
                        </h4>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Booking ID</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Route</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Date</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Seats</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Amount</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sampleBookings.map(booking => `
                                    <tr style="border-bottom: 1px solid #dee2e6;">
                                        <td style="padding: 12px;"><strong>${booking.id}</strong></td>
                                        <td style="padding: 12px;">${booking.route}</td>
                                        <td style="padding: 12px;">${new Date(booking.date).toLocaleDateString()}</td>
                                        <td style="padding: 12px;">${booking.seats}</td>
                                        <td style="padding: 12px;">ETB ${booking.amount}</td>
                                        <td style="padding: 12px;">
                                            <span class="status-badge status-${booking.status}">
                                                ${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            modal.classList.add('active');
        }

        function closeUserBookingsModal() {
            const modal = document.getElementById('userBookingsModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Notification function
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Add notification styles if not already added
            if (!document.getElementById('notification-styles')) {
                const styles = document.createElement('style');
                styles.id = 'notification-styles';
                styles.textContent = `
                    .notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        min-width: 300px;
                        padding: 15px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        animation: slideInRight 0.3s ease;
                    }
                    .notification-success { 
                        background: #d4edda; 
                        color: #155724; 
                        border-left: 4px solid #28a745; 
                    }
                    .notification-error { 
                        background: #f8d7da; 
                        color: #721c24; 
                        border-left: 4px solid #dc3545; 
                    }
                    .notification-content { 
                        display: flex; 
                        align-items: center; 
                        gap: 10px; 
                    }
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 4000);
        }

        async function saveUser(e) {
            e.preventDefault();
            
            const modal = document.getElementById('userModal');
            const mode = modal.dataset.mode;
            const userId = modal.dataset.userId;
            const saveBtn = document.getElementById('saveUserBtn');
            const originalText = saveBtn.innerHTML;
            
            try {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
                
                const formData = {
                    full_name: document.getElementById('userFullName').value.trim(),
                    email: document.getElementById('userEmail').value.trim(),
                    phone: document.getElementById('userPhone').value.trim(),
                    status: document.getElementById('userStatus').value
                };
                
                if (mode === 'add') {
                    formData.password = document.getElementById('userPassword').value;
                }
                
                console.log(`${mode === 'add' ? 'Adding' : 'Updating'} user:`, formData);
                
                // Simulate API call (replace with actual API call)
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (mode === 'add') {
                    // Add new user to the list
                    const newUser = {
                        id: `USR${(currentUsers.length + 1).toString().padStart(3, '0')}`,
                        ...formData,
                        total_bookings: 0,
                        trips_taken: 0,
                        registration_date: new Date().toISOString().split('T')[0],
                        email_verified: formData.status === 'verified'
                    };
                    currentUsers.unshift(newUser);
                } else if (mode === 'edit') {
                    // Update existing user
                    const userIndex = currentUsers.findIndex(u => u.id === userId);
                    if (userIndex !== -1) {
                        currentUsers[userIndex] = { ...currentUsers[userIndex], ...formData };
                    }
                }
                
                // Refresh display
                updateStatistics();
                filteredUsers = [...currentUsers];
                displayUsers(filteredUsers);
                
                closeUserModal();
                
                // Show success message
                showAdminAlert(`User ${mode === 'add' ? 'added' : 'updated'} successfully!`, 'success');
                
            } catch (error) {
                console.error(`Failed to ${mode} user:`, error);
                showAdminAlert(`Failed to ${mode} user. Please try again.`, 'error');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        function exportUsers() {
            try {
                // Create CSV content
                const headers = ['User ID', 'Full Name', 'Email', 'Phone', 'Account Status', 'Total Bookings', 'Trips Taken', 'Registration Date'];
                const csvContent = [
                    headers.join(','),
                    ...filteredUsers.map(user => [
                        user.id,
                        `"${user.full_name}"`,
                        user.email,
                        `"${user.phone}"`,
                        user.status,
                        user.total_bookings,
                        user.trips_taken,
                        user.registration_date
                    ].join(','))
                ].join('\n');

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `users_export_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAdminAlert(`<strong>${filteredUsers.length}</strong> users exported successfully!`, 'success', 'Export Complete');
            } catch (error) {
                console.error('Export failed:', error);
                showAdminAlert('Export failed. Please try again.', 'error');
            }
        }

        function showLoadingState() {
            try {
                const loadingElement = document.getElementById('loadingState');
                if (loadingElement) {
                    loadingElement.style.display = 'block';
                } else {
                    console.warn('‚ö†Ô∏è Loading state element not found');
                }
            } catch (error) {
                console.error('Error in showLoadingState:', error);
            }
        }

        function hideLoadingState() {
            try {
                const loadingElement = document.getElementById('loadingState');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                } else {
                    console.warn('‚ö†Ô∏è Loading state element not found');
                }
            } catch (error) {
                console.error('Error in hideLoadingState:', error);
            }
        }

        function showErrorMessage(message) {
            const container = document.getElementById('usersTableContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="loadUsersData()">
                        <i class="fas fa-retry"></i>
                        Try Again
                    </button>
                </div>
            `;
        }

        // Profile sync functionality
        function updatePageElements(data) {
            try {
                // Update sidebar admin name
                const sidebarAdminName = document.getElementById('sidebarAdminName');
                if (sidebarAdminName) {
                    sidebarAdminName.textContent = data.full_name || data.name || 'Admin User';
                }
                
                // Update profile image if changed
                if (data.profile_image) {
                    const adminAvatar = document.querySelector('.admin-avatar img');
                    if (adminAvatar) {
                        adminAvatar.src = data.profile_image;
                        adminAvatar.style.display = 'block';
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Failed to update page elements:', error);
            }
        }

        // Listen for profile updates from other pages
        window.addEventListener('adminProfileUpdated', function(event) {
            const updatedData = event.detail;
            console.log('üì° Received profile update:', updatedData);
            updatePageElements(updatedData);
        });

        // Mobile menu toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebar = document.getElementById('sidebar');
            
            if (mobileMenuBtn && sidebar) {
                mobileMenuBtn.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
                
                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', function(e) {
                    if (window.innerWidth <= 992 && 
                        !sidebar.contains(e.target) && 
                        !mobileMenuBtn.contains(e.target) && 
                        sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                    }
                });
            }
        });
    </script>
</body>
</html>